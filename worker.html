<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darbinieks</title>
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            margin: 0; 
            background: #f4f6f1; 
            color: #0f1a14; 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            align-items: center; /* Mainīts uz center labākam vizuālajam tēlam */
        }
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            width: 100%;
            max-width: 1000px; 
            margin-bottom: 20px;
        }
        h2 { margin-top: 0; color: #2c3e50; }
        #status { margin-bottom: 10px; font-size: 1.1em; }
        #startTimeDisplay { margin-bottom: 20px; font-size: 0.95em; }

        /* Kontroles bloks */
        #workControls { 
            display: flex; flex-wrap: wrap; gap: 12px; align-items: center; 
            padding: 20px; background: #f8f9fa; border: 1px solid #e9ecef; 
            border-radius: 10px; margin-bottom: 20px;
        }
        select { padding: 10px 15px; border-radius: 8px; border: 1px solid #ced4da; font-size: 14px; min-width: 180px; cursor: pointer; }
        
        button { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
        #AtWork { background: #007bff; color: white; }
        #LeaveWork { background: #dc3545; color: white; display: none; margin-left: auto; }
        #startBtn { background: #28a745; color: white; }
        #stopBtn { background: #ffc107; color: #212529; }
        #logoutBtn { background: #6c757d; color: white; margin-top: 20px; }

        /* Tabulas stils */
        table { border-collapse: collapse; margin-top: 15px; width: 100%; background: white; font-size: 13px; }
        th { background: #f8f9fa; border-bottom: 2px solid #dee2e6; padding: 12px; }
        td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; }
        
        .flex-container { display: flex; gap: 20px; width: 100%; margin-top: 20px; align-items: flex-start; }
        .side-box { flex: 1; background: #fff; padding: 20px; border-radius: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="welcome"></h2>
        
        <div style="display: flex; width: 100%; margin-bottom: 15px; gap: 10px;">
            <button id="AtWork">SĀKT MAIŅU</button>
            <button id="LeaveWork">BEIGT MAIŅU</button>
        </div>

        <div id="workControls">
            <select id="car"><option value="">-- Izvēlies mašīnu --</option></select>
            <select id="object"><option value="">-- Izvēlies objektu --</option></select>
            <select id="work"><option value="">-- Izvēlies darba veidu --</option></select>
            <button id="startBtn" style="display:none;">Sākt konkrētu darbu</button>
            <button id="stopBtn" style="display:none;">Beigt konkrētu darbu</button>
        </div>

        <div id="status">Statuss: Gaidīšana</div>
        <div id="startTimeDisplay" style="color: green; font-weight: bold;"></div>

        <div class="flex-container">
            <div class="side-box" style="max-width: 300px;">
                <h3>Aktīvais laiks</h3>
                <div id="activeTimerDisplay" style="font-size: 32px; font-weight: bold; color: #2c7a7b; margin-bottom: 15px;">00:00:00</div>
            </div>

            <div class="side-box">
                <h3 style="margin-top:0;">Pēdējās maiņas (DarbaStundas)</h3>
                <div id="shiftTableContainer">Ielādē...</div>
            </div>
        </div>

        <button id="logoutBtn">Iziet</button>
    </div>

    <div class="card" style="max-width: 1000px;">
        <h3>Tavi pēdējie veiktie darbi:</h3>
        <div id="tableContainer"></div>
    </div>

<script>
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!user || user.role !== "worker") window.location.href = "index.html";
    document.getElementById("welcome").textContent = `Darbinieks: ${user.name}`;

    const MONTHS_LV = ["Janvāris","Februāris","Marts","Aprīlis","Maijs","Jūnijs","Jūlijs","Augusts","Septembris","Oktobris","Novembris","Decembris"];
    const carSelect = document.getElementById("car");
    const objectSelect = document.getElementById("object");
    const workSelect = document.getElementById("work");
    let startTimeShift;
    let timerInterval;

    async function loadWorkerData() {
        try {
            const [cRes, oRes, wRes, sRes, dsRes] = await Promise.all([
                fetch('/api/cars'), fetch('/api/objects'), fetch('/api/work-types'), 
                fetch('/api/schedule'), fetch('/api/darba-stundas')
            ]);
            
            const cars = await cRes.json();
            const objects = await oRes.json();
            const workTypes = await wRes.json();
            const allSchedule = await sRes.json();
            const allShifts = await dsRes.json();

            fillSelect(carSelect, cars, "-- Izvēlies mašīnu --");
            fillSelect(objectSelect, objects, "-- Izvēlies objektu --");
            fillSelect(workSelect, workTypes, "-- Izvēlies darba veidu --");

            // Filtrējam datus tikai šim darbiniekam
            renderTable(allSchedule.filter(e => e.worker_name === user.name));
            renderShiftTable(allShifts.filter(s => s.darbinieks === user.name));

            // Pārbauda aktīvo darbu (schedule)
            const activeJob = allSchedule.find(e => e.worker_name === user.name && !e.beigu_laiks);
            if (activeJob) {
                document.getElementById("startBtn").style.display = "none";
                document.getElementById("stopBtn").style.display = "block";
                [carSelect, objectSelect, workSelect].forEach(s => s.disabled = true);
                document.getElementById("status").innerHTML = `Strādā: <b>${activeJob.objekts}</b>`;
            }
        } catch (err) { console.error(err); }
    }

    // TAIMERA UN MAIŅAS LOGIKA (DarbaStundas)
    document.getElementById("AtWork").onclick = () => {
        startTimeShift = new Date();
        document.getElementById("AtWork").style.display = "none";
        document.getElementById("LeaveWork").style.display = "block";
        document.getElementById("startBtn").style.display = "block";
        timerInterval = setInterval(updateTimer, 1000);
    };

    function updateTimer() {
        const now = new Date();
        const diff = new Date(now - startTimeShift);
        const h = String(diff.getUTCHours()).padStart(2, '0');
        const m = String(diff.getUTCMinutes()).padStart(2, '0');
        const s = String(diff.getUTCSeconds()).padStart(2, '0');
        document.getElementById("activeTimerDisplay").textContent = `${h}:${m}:${s}`;
    }

    document.getElementById("LeaveWork").onclick = async () => {
        if(!confirm("Vai tiešām beigt darba dienu?")) return;
        const endTime = new Date();
        clearInterval(timerInterval);
        
        const hoursWorked = ((endTime - startTimeShift) / (1000 * 60 * 60)).toFixed(2);
        
        const shiftData = {
            darbinieks: user.name,
            datums: startTimeShift.toLocaleDateString('lv-LV'),
            sāka_darbu: startTimeShift.toLocaleTimeString('lv-LV', {hour:'2-digit', minute:'2-digit'}),
            beidza_darbu: endTime.toLocaleTimeString('lv-LV', {hour:'2-digit', minute:'2-digit'}),
            month: MONTHS_LV[startTimeShift.getMonth()],
            stundas: hoursWorked
        };

        const res = await fetch('/api/darba-stundas', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(shiftData)
        });

        if(res.ok) location.reload();
    };

    // KONKRĒTA DARBA LOGIKA (Schedule)
    document.getElementById("startBtn").onclick = async () => {
        if (!carSelect.value || !objectSelect.value || !workSelect.value) return alert("Izvēlies visus laukus!");
        const now = new Date();
        const res = await fetch('/api/start-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                worker_name: user.name, 
                car: carSelect.value, 
                objekts: objectSelect.value, 
                darbs: workSelect.value, 
                start_time: `${now.toLocaleDateString('lv-LV')} ${now.toLocaleTimeString('lv-LV')}` 
            })
        });
        if (res.ok) loadWorkerData();
    };

    document.getElementById("stopBtn").onclick = async () => {
        const now = new Date();
        const res = await fetch('/api/stop-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ worker_name: user.name, end_time: `${now.toLocaleDateString('lv-LV')} ${now.toLocaleTimeString('lv-LV')}` })
        });
        if (res.ok) loadWorkerData();
    };

    function renderShiftTable(data) {
        let html = `<table><tr><th>Datums</th><th>Sāka</th><th>Beidza</th><th>H</th></tr>`;
        data.slice(-5).reverse().forEach(s => {
            html += `<tr><td>${s.datums}</td><td>${s.sāka_darbu}</td><td>${s.beidza_darbu}</td><td><b>${s.stundas}</b></td></tr>`;
        });
        document.getElementById("shiftTableContainer").innerHTML = html + "</table>";
    }

    function renderTable(data) {
        let html = `<table><tr><th>Auto</th><th>Objekts</th><th>Darbs</th><th>Sākums</th><th>Stundas</th></tr>`;
        data.slice().reverse().forEach(e => {
            html += `<tr><td>${e.car}</td><td>${e.objekts || '-'}</td><td>${e.darbs || '-'}</td><td>${e.sākuma_laiks}</td><td>${e.hours || '-'}</td></tr>`;
        });
        document.getElementById("tableContainer").innerHTML = html + "</table>";
    }

    function fillSelect(selectEl, data, defaultText) {
        selectEl.innerHTML = `<option value="">${defaultText}</option>`;
        data.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item; opt.textContent = item;
            selectEl.appendChild(opt);
        });
    }

    document.getElementById("logoutBtn").onclick = () => { localStorage.removeItem("loggedInUser"); window.location.href = "index.html"; };
    loadWorkerData();
</script>
</body>
</html>
