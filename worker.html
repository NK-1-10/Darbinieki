<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darbinieks</title>
    <style>
        body {
        background-color: Coral;
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
    }
    /* Iesaku pievienot šo, lai baltais rāmis (card) būtu salasāms uz zilā fona */
    .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
        table { border-collapse: collapse; margin-top: 15px; width: 100%; }
        th, td { border: 1px solid #333; padding: 6px 12px; text-align: center; }
        form { margin-bottom: 20px; }
        select, input, button { margin: 4px; padding: 4px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="welcome"></h2>
        <div id="status">Statuss: Gaidīšana</div>
<div id="startTimeDisplay" style="color: green; font-weight: bold;"></div>

        <select id="car" required>
            <option value="">-- Izvēlies mašīnu --</option>
        </select>

        <button id="startBtn" class="btn btn-start">SĀKT DARBU</button>
        <button id="stopBtn" class="btn btn-stop" style="display:none;">BEIGT DARBU</button>
        
        <br><br>
        <button id="logoutBtn">Logout</button>
    </div>

    <h3>Tavi pēdējie ieraksti:</h3>
    <div id="tableContainer"></div>
   <script>
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!user || user.role !== "worker") {
        window.location.href = "index.html";
    }
    document.getElementById("welcome").textContent = `Logged in as: ${user.name}`;

    const carSelect = document.getElementById("car");
    const tableContainer = document.getElementById("tableContainer");

    // 1. Funkcija datu ielādei (Pārcelta uz augšu)
   async function loadWorkerData() {
        try {
            const [cRes, sRes] = await Promise.all([
                fetch('/api/cars'),
                fetch('/api/schedule')
            ]);
            
            if (!cRes.ok || !sRes.ok) throw new Error("Servera kļūda");

            const cars = await cRes.json();
            const allSchedule = await sRes.json();

            carSelect.innerHTML = '<option value="">-- Izvēlies mašīnu --</option>';
            cars.forEach(c => {
                carSelect.add(new Option(c, c));
            });

            // Svarīgi: te mēs pārbaudām 'beigu_laiks', nevis 'end_time'
            const activeJob = allSchedule.find(e => e.worker_name === user.name && !e.beigu_laiks);
            
            if (activeJob) {
                document.getElementById("startBtn").style.display = "none";
                document.getElementById("stopBtn").style.display = "block";
                carSelect.value = activeJob.car;
                carSelect.disabled = true;
                document.getElementById("status").innerHTML = `Strādā ar: <b>${activeJob.car}</b>`;
                document.getElementById("startTimeDisplay").innerText = `Tu sāki darbu: ${activeJob.sākuma_laiks}`;
            } else {
                document.getElementById("startBtn").style.display = "block";
                document.getElementById("stopBtn").style.display = "none";
                carSelect.disabled = false;
                document.getElementById("status").textContent = "Statuss: Gaidīšana";
                document.getElementById("startTimeDisplay").innerText = "";
            }

            renderTable(allSchedule.filter(e => e.worker_name === user.name));
        } catch (err) {
            console.error("Kļūda ielādējot datus:", err);
        }
    }

   function renderTable(data) {
    if (!data || !data.length) { tableContainer.innerHTML = "Nav ierakstu."; return; }
    
    let html = `
        <table>
            <tr>
                <th>Auto</th>
                <th>Datums</th>
                <th>Sākums</th>
                <th>Beigas</th>
                <th>Stundas</th>
            </tr>`;
            
    data.forEach(e => {
        html += `
            <tr>
                <td>${e.car}</td>
                <td>${e.date || '-'}</td>
                <td>${e.sākuma_laiks || '-'}</td>
                <td>${e.beigu_laiks || 'Aktīvs'}</td>
                <td>${e.hours ? e.hours + ' h' : '-'}</td>
            </tr>`;
    });
    tableContainer.innerHTML = html + "</table>";
}

    // 3. Pogas funkcijas
    document.getElementById("startBtn").onclick = async () => {
    if (!carSelect.value) return alert("Lūdzu, izvēlies mašīnu!");

    // 1. Iegūstam laiku no datora (tāpat kā tavā piemērā) !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    const now = new Date();
    const formattedTime = now.toLocaleTimeString('lv-LV', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false // Pārliecināmies, ka ir 24h formāts
    });
    const formattedDate = now.toLocaleDateString('lv-LV');
    const fullTimestamp = `${formattedDate} ${formattedTime}`;
    // 2. Nosūtām datus uz serveri
const sākuma_laiks = fullTimestamp;
        
    const res = await fetch('/api/start-work', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            worker_name: user.name, 
            car: carSelect.value,
            start_time: sākuma_laiks
        })
    });
    if (res.ok) {
        // 3. Ja serveris apstiprina, parādām laiku ekrānā
        document.getElementById("startTimeDisplay").innerText = `Tu sāki darbu: ${fullTimestamp}`;
        const poga = document.getElementById("stopBtn");
        poga.style.display = "block";
        // Pārlādējam datus (pogas un tabulu)
        loadWorkerData();
    } else {
        alert("Kļūda saglabājot sākuma laiku.");
    }
};

    document.getElementById("stopBtn").onclick = async () => {
        if (!confirm("Vai tiešām beigt darbu?")) return;
        const res = await fetch('/api/stop-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ worker_name: user.name })
        });
        if (res.ok) loadWorkerData();
    };

    document.getElementById("logoutBtn").onclick = () => {
        localStorage.removeItem("loggedInUser");
        window.location.href = "index.html";
    };

    // PALAIŽAM IELĀDI
    loadWorkerData();
</script>
</body>
</html>
