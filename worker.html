<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darbinieks</title>
    <style>
        table { border-collapse: collapse; margin-top: 15px; width: 100%; }
        th, td { border: 1px solid #333; padding: 6px 12px; text-align: center; }
        form { margin-bottom: 20px; }
        select, input, button { margin: 4px; padding: 4px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="welcome"></h2>
        <div id="status">Statuss: Gaidīšana</div>

        <select id="car" required>
            <option value="">-- Izvēlies mašīnu --</option>
        </select>

        <button id="startBtn" class="btn btn-start">SĀKT DARBU</button>
        <button id="stopBtn" class="btn btn-stop" style="display:none;">BEIGT DARBU</button>
        
        <br><br>
        <button id="logoutBtn">Logout</button>
    </div>

    <h3>Tavi pēdējie ieraksti:</h3>
    <div id="tableContainer"></div>
   <script>
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!user || user.role !== "worker") {
        window.location.href = "index.html";
    }
    document.getElementById("welcome").textContent = `Logged in as: ${user.name}`;

    const carSelect = document.getElementById("car");
    const tableContainer = document.getElementById("tableContainer");

    // 1. Funkcija datu ielādei (Pārcelta uz augšu)
    async function loadWorkerData() {
        try {
            const [cRes, sRes] = await Promise.all([
                fetch('/api/cars'),
                fetch('/api/schedule')
            ]);
            
            if (!cRes.ok || !sRes.ok) throw new Error("Servera kļūda");

            const cars = await cRes.json();
            const allSchedule = await sRes.json();

            // Aizpildām mašīnu sarakstu
            carSelect.innerHTML = '<option value="">-- Izvēlies mašīnu --</option>';
            cars.forEach(c => {
                carSelect.add(new Option(c, c));
            });

            // Pārbaudām aktīvo darbu
            const activeJob = allSchedule.find(e => e.worker_name === user.name && !e.end_time);
            if (activeJob) {
                document.getElementById("startBtn").style.display = "none";
                document.getElementById("stopBtn").style.display = "block";
                carSelect.value = activeJob.car;
                carSelect.disabled = true;
                document.getElementById("status").innerHTML = `Strādā ar: <b>${activeJob.car}</b>`;
            } else {
                document.getElementById("startBtn").style.display = "block";
                document.getElementById("stopBtn").style.display = "none";
                carSelect.disabled = false;
                document.getElementById("status").textContent = "Statuss: Gaidīšana";
            }

            renderTable(allSchedule.filter(e => e.worker_name === user.name));
        } catch (err) {
            console.error("Kļūda ielādējot datus:", err);
        }
    }

    // 2. Tabulas renderēšana
    function renderTable(data) {
        if (!data || !data.length) { tableContainer.innerHTML = "Nav ierakstu."; return; }
        let html = "<table><tr><th>Auto</th><th>Sākums</th><th>Beigas</th></tr>";
        data.forEach(e => {
            html += `<tr><td>${e.car}</td><td>${e.start_time || '-'}</td><td>${e.end_time || 'Aktīvs'}</td></tr>`;
        });
        tableContainer.innerHTML = html + "</table>";
    }

    // 3. Pogas funkcijas
    document.getElementById("startBtn").onclick = async () => {
        if (!carSelect.value) return alert("Lūdzu, izvēlies mašīnu!");
        const res = await fetch('/api/start-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ worker_name: user.name, car: carSelect.value })
        });
        if (res.ok) loadWorkerData();
    };

    document.getElementById("stopBtn").onclick = async () => {
        if (!confirm("Vai tiešām beigt darbu?")) return;
        const res = await fetch('/api/stop-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ worker_name: user.name })
        });
        if (res.ok) loadWorkerData();
    };

    document.getElementById("logoutBtn").onclick = () => {
        localStorage.removeItem("loggedInUser");
        window.location.href = "index.html";
    };

    // PALAIŽAM IELĀDI
    loadWorkerData();
</script>
</body>
</html>
