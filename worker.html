<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darbinieks</title>
    <style>
        table { border-collapse: collapse; margin-top: 15px; width: 100%; }
        th, td { border: 1px solid #333; padding: 6px 12px; text-align: center; }
        form { margin-bottom: 20px; }
        select, input, button { margin: 4px; padding: 4px; }
    </style>
</head>
<body>
    <h2 id="welcome"></h2>
    <button id="logoutBtn">Logout</button>
    <br>
    <br>

    <form id="scheduleForm">
        <select id="month" required>
            <option value="">Mēnesis:</option>
        </select>

        <select id="date" required>
            <option value="">Datums:</option>
        </select>

        <select id="car" required>
            <option value="">Mašīna:</option>
        </select>

        <label>Kopš:</label>
        <select id="fromHour" required></select> :
        <select id="fromMinute" required></select>

        <label>Līdz:</label>
        <select id="toHour" required></select> :
        <select id="toMinute" required></select>

        <span id="hoursDisplay">Stundas:  0h 0m</span>
        <button type="submit">Pievienot</button>
    </form>

    <div id="tableContainer"></div>

   <script>
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!user || user.role !== "worker") {
        window.location.href = "index.html";
    }
    document.getElementById("welcome").textContent = `Logged in as: ${user.name}`;

    const scheduleForm = document.getElementById("scheduleForm");
    const carSelect = document.getElementById("car");
    const tableContainer = document.getElementById("tableContainer");

    // Ielādēt datus no Railway
    async function loadWorkerData() {
        const [cRes, sRes] = await Promise.all([
            fetch('/api/cars'),
            fetch('/api/schedule')
        ]);
        const cars = await cRes.json();
        const allSchedule = await sRes.json();

        // Mašīnu dropdown
        carSelect.innerHTML = '<option value="">Mašīna:</option>';
        cars.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            carSelect.appendChild(opt);
        });

        renderTable(allSchedule.filter(e => e.worker_name === user.name));
    }

    // Saglabāt jaunu ierakstu
    scheduleForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const { hours, minutes } = calculateHours(
            parseInt(document.getElementById("fromHour").value),
            parseInt(document.getElementById("fromMinute").value),
            parseInt(document.getElementById("toHour").value),
            parseInt(document.getElementById("toMinute").value)
        );

        const entry = {
            worker_name: user.name,
            month: document.getElementById("month").value,
            date: parseInt(document.getElementById("date").value),
            car: carSelect.value,
            from_time: `${document.getElementById("fromHour").value}:${document.getElementById("fromMinute").value}`,
            to_time: `${document.getElementById("toHour").value}:${document.getElementById("toMinute").value}`,
            hours: `${hours}h ${minutes}m`
        };

        const res = await fetch('/api/schedule', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(entry)
        });

        if(res.ok) {
            alert("Saglabāts datubāzē!");
            scheduleForm.reset();
            loadWorkerData();
        }
    });

    // Palīgfunkcijas laika dropdowniem un aprēķinam
    function populateTimeDropdowns(sH, sM) {
        for(let i=0; i<24; i++) sH.add(new Option(i.toString().padStart(2,'0'), i));
        for(let i=0; i<60; i++) sM.add(new Option(i.toString().padStart(2,'0'), i));
    }
    populateTimeDropdowns(document.getElementById("fromHour"), document.getElementById("fromMinute"));
    populateTimeDropdowns(document.getElementById("toHour"), document.getElementById("toMinute"));

    function calculateHours(fH, fM, tH, tM) {
        let diff = (tH * 60 + tM) - (fH * 60 + fM);
        if(diff < 0) diff += 1440;
        return { hours: Math.floor(diff/60), minutes: diff%60 };
    }

    function renderTable(data) {
        if(!data.length) { tableContainer.innerHTML = "Nav ierakstu."; return; }
        let html = "<table><tr><th>Month</th><th>Date</th><th>Car</th><th>From</th><th>To</th><th>Hours</th></tr>";
        data.forEach(e => {
            html += `<tr><td>${e.month}</td><td>${e.date}</td><td>${e.car}</td><td>${e.from_time}</td><td>${e.to_time}</td><td>${e.hours}</td></tr>`;
        });
        tableContainer.innerHTML = html + "</table>";
    }

    // Logout
    document.getElementById("logoutBtn").onclick = () => {
        localStorage.removeItem("loggedInUser");
        window.location.href = "index.html";
    };

    loadWorkerData();
</script>
</body>
</html>
