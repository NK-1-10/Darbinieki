<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darbinieks</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); max-width: 800px; margin: 0 auto; }
        h2 { margin-top: 0; color: #2c3e50; }
        #status { margin-bottom: 10px; font-size: 1.1em; }
        #startTimeDisplay { margin-bottom: 20px; font-size: 0.95em; }
        #workControls { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; padding: 20px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; margin-bottom: 20px; }
        select { padding: 10px 15px; border-radius: 8px; border: 1px solid #ced4da; background-color: white; font-size: 14px; outline: none; min-width: 180px; cursor: pointer; }
        select:disabled { background-color: #e9ecef; cursor: not-allowed; }
        button { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
        #AtWork { background: #007bff; color: white; width: 100%; }
        #LeaveWork { background: #dc3545; color: white; display: none; width: 100%; }
        #startBtn { background: #28a745; color: white; }
        #stopBtn { background: #ffc107; color: #212529; }
        #logoutBtn { background: #6c757d; color: white; margin-top: 20px; }
        table { border-collapse: collapse; margin-top: 25px; width: 100%; background: white; border-radius: 8px; overflow: hidden; }
        th { background: #f8f9fa; border-bottom: 2px solid #dee2e6; padding: 12px; }
        td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; }
        #tableContainer {background: #fff; border: 1px solid #ccc; border-radius: 10px; overflow: hidden; width: 100%; max-width: 1400px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="welcome"></h2>
        <div id="status">Statuss: Gaidīšana</div>
        <div id="startTimeDisplay" style="color: green; font-weight: bold;"></div>

        <div style="margin-bottom: 15px;">
            <button id="AtWork">ESMU DARBĀ</button>
            <button id="LeaveWork">DODOS PROJĀM</button>
        </div>

        <div id="workControls">
            <select id="car" required><option value="">-- Izvēlies mašīnu --</option></select>
            <select id="object" required><option value="">-- Izvēlies objektu --</option></select>
            <select id="work" required><option value="">-- Izvēlies darba veidu --</option></select>
            
            <button id="startBtn" style="display:none;">Sākt darbu</button>
            <button id="stopBtn" style="display:none;">Beigt darbu</button>

            <button id="Ella" class="oil-btn" style="display:none; background: #6f42c1; color: white;">Pieleju Eļļu</button>
            <button id="Degviela" class="fuel-btn" style="display:none; background: #fd7e14; color: white;">Pielej Degvielu</button>
        </div>

        <div id="resourceModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:25px; border-radius:12px; width:90%; max-width:400px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
        <h3 id="modalTitle" style="margin-top:0;">Pievienot resursu</h3>
        
        <label>Izvēlies mašīnu:</label>
        <select id="modalCarSelect" style="width:100%; padding:10px; margin: 10px 0 20px 0; border-radius:8px; border:1px solid #ccc;"></select>
        
        <label>Ievadi litrus:</label>
        <input type="number" id="modalAmountInput" step="0.01" placeholder="0.00" style="width:100%; padding:10px; margin: 10px 0 20px 0; border-radius:8px; border:1px solid #ccc; box-sizing: border-box;">
        
        <div style="display:flex; gap:10px;">
            <button id="modalCancel" style="flex:1; background:#6c757d; color:white; padding:12px; border-radius:8px; border:none; cursor:pointer;">Atcelt</button>
            <button id="modalSave" style="flex:1; background:#28a745; color:white; padding:12px; border-radius:8px; border:none; cursor:pointer; font-weight:bold;">Saglabāt</button>
        </div>
    </div>
</div>

        <button id="logoutBtn">Izrakstīties</button>
    </div>

    <h3>Tavi pēdējie ieraksti:</h3>
    <div id="tableContainer"></div>

<script>
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!user) { window.location.href = "index.html"; } 
    else if (user.role === "admin") { window.location.href = "admin.html"; }

    document.getElementById("welcome").textContent = `Darbinieks: ${user.name}`;

    const carSelect = document.getElementById("car");
    const objectSelect = document.getElementById("object");
    const workSelect = document.getElementById("work");
    const tableContainer = document.getElementById("tableContainer");
    
    let currentResourceType = ""; 

    // --- MODĀLĀ LOGA FUNKCIJAS ---
    function openResourceModal(type) {
        currentResourceType = type;
        document.getElementById("modalTitle").innerText = type === "Ella" ? "Eļļas pieliešana" : "Degvielas uzpilde";
        
        const mainSelect = document.getElementById("car");
        const modalSelect = document.getElementById("modalCarSelect");
        
        // Pārkopējam opcijas no galvenā selekta
        modalSelect.innerHTML = mainSelect.innerHTML; 
        modalSelect.value = mainSelect.value;

        document.getElementById("resourceModal").style.display = "flex";
    }

    document.getElementById("Ella").onclick = () => openResourceModal("Ella");
    document.getElementById("Degviela").onclick = () => openResourceModal("Degviela");

    document.getElementById("modalCancel").onclick = () => {
        document.getElementById("resourceModal").style.display = "none";
        document.getElementById("modalAmountInput").value = "";
    };

    document.getElementById("modalSave").onclick = async () => {
        const auto = document.getElementById("modalCarSelect").value;
        const litri = document.getElementById("modalAmountInput").value;

        if (!auto) return alert("Izvēlies mašīnu!");
        if (!litri || litri <= 0) return alert("Ievadi derīgu litru daudzumu!");

        try {
            const res = await fetch('/api/update-resources', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    worker_name: user.name, 
                    car: auto, 
                    type: currentResourceType, 
                    amount: litri.replace(',', '.') 
                })
            });

            if (res.ok) {
                alert(`Veiksmīgi saglabāts: ${auto} ielieti ${litri} l.`);
                document.getElementById("resourceModal").style.display = "none";
                document.getElementById("modalAmountInput").value = "";
            } else {
                alert("Kļūda saglabājot datus.");
            }
        } catch (err) {
            console.error("Kļūda:", err);
            alert("Servera savienojuma kļūda.");
        }
    };

    // --- PAMATDATU IELĀDE ---
    function fillSelect(selectEl, data, defaultText) {
        const currentVal = selectEl.value;
        selectEl.innerHTML = `<option value="">${defaultText}</option>`;
        data.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item;
            opt.textContent = item;
            selectEl.appendChild(opt);
        });
        selectEl.value = currentVal;
    }

    async function loadWorkerData() {
        try {
            const [cRes, oRes, wRes, sRes] = await Promise.all([
                fetch('/api/cars'), fetch('/api/objects'), fetch('/api/work-types'), fetch('/api/schedule')
            ]);
            
            const cars = await cRes.json();
            const objects = await oRes.json();
            const workTypes = await wRes.json();
            const allSchedule = await sRes.json();

            fillSelect(carSelect, cars, "-- Izvēlies mašīnu --");
            fillSelect(objectSelect, objects, "-- Izvēlies objektu --");
            fillSelect(workSelect, workTypes, "-- Izvēlies darba veidu --");

            const activeJob = allSchedule.find(e => e.worker_name === user.name && !e.beigu_laiks);
            const shiftStartTime = localStorage.getItem(`shift_start_${user.name}`);

            // UI stāvokļa pārvaldība
            if (activeJob) {
                document.getElementById("startBtn").style.display = "none";
                document.getElementById("stopBtn").style.display = "block";
                [carSelect, objectSelect, workSelect].forEach(s => s.disabled = true);
                carSelect.value = activeJob.car;
                objectSelect.value = activeJob.objekts || "";
                workSelect.value = activeJob.darbs || "";
                document.getElementById("status").innerHTML = `Strādā: <b>${activeJob.objekts}</b> (${activeJob.car})`;
                document.getElementById("startTimeDisplay").innerText = `Sāki: ${activeJob.sākuma_laiks}`;
            } else {
                [carSelect, objectSelect, workSelect].forEach(s => s.disabled = false);
                document.getElementById("startBtn").style.display = shiftStartTime ? "block" : "none";
                document.getElementById("stopBtn").style.display = "none";
                document.getElementById("status").textContent = shiftStartTime ? "Statuss: Maiņa sākta" : "Statuss: Gaidīšana";
                document.getElementById("startTimeDisplay").innerText = "";
            }

            if (shiftStartTime || activeJob) {
                document.getElementById("AtWork").style.display = "none";
                document.getElementById("LeaveWork").style.display = "block";
                document.getElementById("Ella").style.display = "block";
                document.getElementById("Degviela").style.display = "block";
            } else {
                document.getElementById("AtWork").style.display = "block";
                document.getElementById("LeaveWork").style.display = "none";
                document.getElementById("Ella").style.display = "none";
                document.getElementById("Degviela").style.display = "none";
            }

            renderTable(allSchedule.filter(e => e.worker_name === user.name));
        } catch (err) { console.error("Kļūda:", err); }
    }

    // --- MAIŅAS UN UZDEVUMU VADĪBA ---
    document.getElementById("AtWork").onclick = () => {
        const sākumaLaiks = new Date();
        localStorage.setItem(`shift_start_${user.name}`, sākumaLaiks.toISOString());
        loadWorkerData();
    };

    document.getElementById("LeaveWork").onclick = async () => {
        if (!confirm("Beigt darba dienu?")) return;
        const tagad = new Date();
        try {
            await fetch('/api/stop-work', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    worker_name: user.name, 
                    end_time: `${tagad.toLocaleDateString('lv-LV')} ${tagad.toLocaleTimeString('lv-LV')}` 
                })
            });

            const shiftStartRaw = localStorage.getItem(`shift_start_${user.name}`);
            let nostradatasStundas = 0;
            if (shiftStartRaw) {
                const sākums = new Date(shiftStartRaw);
                nostradatasStundas = ((tagad - sākums) / 3600000).toFixed(2);
            }

            const data = {
                darbinieks: user.name,
                datums: tagad.toLocaleDateString('lv-LV'), 
                sāka_darbu: shiftStartRaw ? new Date(shiftStartRaw).toLocaleTimeString('lv-LV') : "--",
                beidza_darbu: tagad.toLocaleTimeString('lv-LV'),
                month: new Intl.DateTimeFormat('lv-LV', { month: 'long' }).format(tagad), 
                stundas: parseFloat(nostradatasStundas) || 0
            };

            const res = await fetch('/api/darba-stundas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                localStorage.removeItem(`shift_start_${user.name}`);
                alert(`Dati saglabāti! Nostrādāts: ${nostradatasStundas} h`);
                window.location.reload(); 
            }
        } catch (err) { console.error("Kļūda:", err); }
    };

    document.getElementById("startBtn").onclick = async () => {
        if (!carSelect.value || !objectSelect.value || !workSelect.value) return alert("Aizpildi laukus!");
        const now = new Date();
        await fetch('/api/start-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                worker_name: user.name, 
                car: carSelect.value,
                objekts: objectSelect.value,
                darbs: workSelect.value,
                start_time: `${now.toLocaleDateString('lv-LV')} ${now.toLocaleTimeString('lv-LV')}` 
            })
        });
        loadWorkerData();
    };

    document.getElementById("stopBtn").onclick = async () => {
        if (!confirm("Beigt darbu?")) return;
        const now = new Date();
        await fetch('/api/stop-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                worker_name: user.name, 
                end_time: `${now.toLocaleDateString('lv-LV')} ${now.toLocaleTimeString('lv-LV')}` 
            })
        });
        loadWorkerData();
    };

    function renderTable(data) {
    if (!data || !data.length) { 
        tableContainer.innerHTML = "Nav ierakstu."; 
        return; 
    }
    
    // Pievienojam galvenei Eļļas un Degvielas kolonnas
    let html = `<table><tr><th>Auto</th><th>Objekts</th><th>Darbs</th><th>Sākums</th><th>Beigas</th><th>Eļļa</th><th>Degv.</th><th>Stundas</th></tr>`;
    
    data.slice().reverse().forEach(e => {
        // Pārliecināmies, ka nolasa pareizos laukus no 'schedule' tabulas
        const ella = e.pielietā_eļļa || '0';
        const degviela = e.pielietā_degviela || '0';
        
        html += `<tr>
            <td>${e.car}</td>
            <td>${e.objekts || '-'}</td>
            <td>${e.darbs || '-'}</td>
            <td>${e.sākuma_laiks || '-'}</td>
            <td>${e.beigu_laiks || 'Aktīvs'}</td>
            <td style="color:#6f42c1; font-weight:bold;">${ella} L</td>
            <td style="color:#fd7e14; font-weight:bold;">${degviela} L</td>
            <td>${e.hours ? e.hours + ' h' : '-'}</td>
        </tr>`;
    });
    tableContainer.innerHTML = html + "</table>";
}

    document.getElementById("logoutBtn").onclick = () => {
        localStorage.removeItem("loggedInUser");
        window.location.href = "index.html";
    };

    loadWorkerData();
</script>
</body>
</html>
