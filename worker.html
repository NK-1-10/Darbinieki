<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darbinieka Panelis</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 1000px; margin: 0 auto 20px; }
        h2, h3 { color: #1a202c; margin-top: 0; }
        
        /* Maiņas pogas */
        .shift-controls { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        #AtWork { background: #3182ce; color: white; width: 100%; }
        #LeaveWork { background: #e53e3e; color: white; display: none; width: 100%; }
        
        /* Darba kontrole */
        .work-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        select { padding: 10px; border-radius: 6px; border: 1px solid #cbd5e0; width: 100%; }
        #startBtn { background: #38a169; color: white; }
        #stopBtn { background: #d69e2e; color: white; display: none; }

        /* Taimeris un info */
        .info-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
        .info-box { flex: 1; min-width: 250px; padding: 20px; border: 1px solid #edf2f7; border-radius: 10px; text-align: center; }
        #activeTimerDisplay { font-size: 2.5rem; font-weight: bold; color: #2d3748; }
        
        /* Tabulas */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th { background: #edf2f7; text-align: left; padding: 10px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #edf2f7; }
        .logout-btn { background: #718096; color: white; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h2 id="welcome">Darbinieks: Ielādē...</h2>
        
        <div class="shift-controls">
            <button id="AtWork">SĀKT MAIŅU</button>
            <button id="LeaveWork">BEIGT MAIŅU</button>
        </div>

        <div id="workControls" class="work-grid">
            <select id="car"><option value="">-- Auto --</option></select>
            <select id="object"><option value="">-- Objekts --</option></select>
            <select id="work"><option value="">-- Darba veids --</option></select>
            <button id="startBtn">Sākt darbu</button>
            <button id="stopBtn">Beigt darbu</button>
        </div>

        <div class="info-row">
            <div class="info-box">
                <h3>Aktīvais laiks</h3>
                <div id="activeTimerDisplay">00:00:00</div>
                <div id="status" style="margin-top:10px; color: #718096;">Statuss: Gaidīšana</div>
            </div>
            <div class="info-box">
                <h3>Pēdējās maiņas</h3>
                <div id="shiftTableContainer">Ielādē...</div>
            </div>
        </div>

        <button class="logout-btn" id="logoutBtn">Iziet</button>
    </div>

    <div class="card">
        <h3>Tavi pēdējie veiktie darbi (Schedule):</h3>
        <div id="tableContainer">Ielādē...</div>
    </div>

<script>
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!user) window.location.href = "index.html";
    document.getElementById("welcome").textContent = `Darbinieks: ${user.name}`;

    const MONTHS = ["Janvāris","Februāris","Marts","Aprīlis","Maijs","Jūnijs","Jūlijs","Augusts","Septembris","Oktobris","Novembris","Decembris"];
    let mainShiftStart = localStorage.getItem(`shift_${user.name}`) ? new Date(localStorage.getItem(`shift_${user.name}`)) : null;
    let timerInterval;

    async function init() {
        try {
            const [cars, objs, works, sched, hours] = await Promise.all([
                fetch('/api/cars').then(r => r.json()),
                fetch('/api/objects').then(r => r.json()),
                fetch('/api/work-types').then(r => r.json()),
                fetch('/api/schedule').then(r => r.json()),
                fetch('/api/darba-stundas').then(r => r.json())
            ]);

            fillSelect("car", cars);
            fillSelect("object", objs);
            fillSelect("work", works);
            
            renderSchedule(sched.filter(i => i.worker_name === user.name));
            renderShifts(hours.filter(i => i.darbinieks === user.name));

            if (mainShiftStart) startUI();
            
            // Pārbauda aktīvo darbu schedule tabulā
            const activeJob = sched.find(i => i.worker_name === user.name && !i.beigu_laiks);
            if (activeJob) {
                document.getElementById("startBtn").style.display = "none";
                document.getElementById("stopBtn").style.display = "block";
                document.getElementById("status").innerHTML = `Strādā: <b>${activeJob.objekts}</b>`;
                ["car", "object", "work"].forEach(id => document.getElementById(id).disabled = true);
            }
        } catch (err) { console.error("Kļūda ielādējot datus:", err); }
    }

    function fillSelect(id, data) {
        const s = document.getElementById(id);
        s.innerHTML = `<option value="">-- Izvēlies --</option>` + data.map(i => `<option value="${i}">${i}</option>`).join('');
    }

    // MAIŅAS KONTROLE (DarbaStundas)
    document.getElementById("AtWork").onclick = () => {
        mainShiftStart = new Date();
        localStorage.setItem(`shift_${user.name}`, mainShiftStart.toISOString());
        startUI();
    };

    function startUI() {
        document.getElementById("AtWork").style.display = "none";
        document.getElementById("LeaveWork").style.display = "block";
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const diff = new Date(new Date() - mainShiftStart);
            document.getElementById("activeTimerDisplay").textContent = diff.toISOString().substr(11, 8);
        }, 1000);
    }

    document.getElementById("LeaveWork").onclick = async () => {
        if (!confirm("Vai tiešām beigt maiņu?")) return;
        const now = new Date();
        const diffHrs = ((now - mainShiftStart) / 3600000).toFixed(2);
        
        await fetch('/api/darba-stundas', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                darbinieks: user.name,
                datums: now.toLocaleDateString('lv-LV'),
                sāka_darbu: mainShiftStart.toLocaleTimeString('lv-LV', {hour:'2-digit', minute:'2-digit'}),
                beidza_darbu: now.toLocaleTimeString('lv-LV', {hour:'2-digit', minute:'2-digit'}),
                month: MONTHS[now.getMonth()],
                stundas: diffHrs + " h" // Sūtam kā tekstu
            })
        });
        localStorage.removeItem(`shift_${user.name}`);
        location.reload();
    };

    // DARBA KONTROLE (Schedule)
    document.getElementById("startBtn").onclick = async () => {
        const car = document.getElementById("car").value;
        const obj = document.getElementById("object").value;
        const wrk = document.getElementById("work").value;
        if (!car || !obj || !wrk) return alert("Aizpildi visus laukus!");

        const now = new Date();
        await fetch('/api/start-work', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                worker_name: user.name, car, objekts: obj, darbs: wrk,
                start_time: `${now.toLocaleDateString('lv-LV')} ${now.toLocaleTimeString('lv-LV')}`
            })
        });
        location.reload();
    };

    document.getElementById("stopBtn").onclick = async () => {
        const now = new Date();
        await fetch('/api/stop-work', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                worker_name: user.name,
                end_time: `${now.toLocaleDateString('lv-LV')} ${now.toLocaleTimeString('lv-LV')}`
            })
        });
        location.reload();
    };

    function renderSchedule(data) {
        let h = `<table><tr><th>Auto</th><th>Objekts</th><th>Sākums</th><th>H</th></tr>`;
        data.reverse().forEach(r => {
            h += `<tr><td>${r.car}</td><td>${r.objekts}</td><td>${r.sākuma_laiks}</td><td>${r.hours || '...'}</td></tr>`;
        });
        document.getElementById("tableContainer").innerHTML = h + `</table>`;
    }

    function renderShifts(data) {
        let h = `<table><tr><th>Datums</th><th>Sāka</th><th>H</th></tr>`;
        data.reverse().slice(0, 5).forEach(r => {
            h += `<tr><td>${r.datums}</td><td>${r.sāka_darbu}</td><td><b>${r.stundas}</b></td></tr>`;
        });
        document.getElementById("shiftTableContainer").innerHTML = h + `</table>`;
    }

    document.getElementById("logoutBtn").onclick = () => { localStorage.clear(); window.location.href = "index.html"; };
    
    init();
</script>
</body>
</html>
