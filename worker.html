<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darbinieks</title>
    <style>
        table { border-collapse: collapse; margin-top: 15px; width: 100%; }
        th, td { border: 1px solid #333; padding: 6px 12px; text-align: center; }
        form { margin-bottom: 20px; }
        select, input, button { margin: 4px; padding: 4px; }
    </style>
</head>
<body>
    <h2 id="welcome"></h2>
    <button id="logoutBtn">Logout</button>
    <br>
    <br>

    <form id="scheduleForm">
        <select id="month" required>
            <option value="">Mēnesis:</option>
        </select>

        <select id="date" required>
            <option value="">Datums:</option>
        </select>

        <select id="car" required>
            <option value="">Mašīna:</option>
        </select>

        <label>Kopš:</label>
        <select id="fromHour" required></select> :
        <select id="fromMinute" required></select>

        <label>Līdz:</label>
        <select id="toHour" required></select> :
        <select id="toMinute" required></select>

        <span id="hoursDisplay">Stundas:  0h 0m</span>
        <button type="submit">Pievienot</button>
    </form>

    <div id="tableContainer"></div>

    <script>
        // ---------- Session Check ----------
        const user = JSON.parse(localStorage.getItem("loggedInUser"));
        if (!user || user.role !== "worker") {
            alert("Please log in first!");
            window.location.href = "login.html";
        }
        document.getElementById("welcome").textContent = `Logged in as: ${user.name}`;

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("loggedInUser");
            window.location.href = "login.html";
        });

        // ---------- Variables ----------
        const scheduleForm = document.getElementById("scheduleForm");
        const tableContainer = document.getElementById("tableContainer");
        const hoursDisplay = document.getElementById("hoursDisplay");

        const monthSelect = document.getElementById("month");
        const dateSelect = document.getElementById("date");
        const carSelect = document.getElementById("car");
        const fromHourSelect = document.getElementById("fromHour");
        const fromMinuteSelect = document.getElementById("fromMinute");
        const toHourSelect = document.getElementById("toHour");
        const toMinuteSelect = document.getElementById("toMinute");

        let schedule = JSON.parse(localStorage.getItem("schedule")) || [];
        const cars = JSON.parse(localStorage.getItem("cars")) || [];

        // ---------- Populate selects ----------
        const months = ["Janvāris","Februāris","Marts","Aprīlis","Maijs","Jūnijs","Jūlijs","Augusts","Septembris","Octobris","Novemberis","Decemberis"];
        months.forEach(m => { const opt = document.createElement("option"); opt.value=m; opt.textContent=m; monthSelect.appendChild(opt); });

        cars.forEach(c => { const opt = document.createElement("option"); opt.value=c; opt.textContent=c; carSelect.appendChild(opt); });

        for(let i=1;i<=31;i++){ const opt=document.createElement("option"); opt.value=i; opt.textContent=i; dateSelect.appendChild(opt); }

        function populateTimeDropdowns(selectHour, selectMinute) {
            for(let h=0;h<24;h++){ const opt=document.createElement("option"); opt.value=h; opt.textContent=h.toString().padStart(2,'0'); selectHour.appendChild(opt);}
            for(let m=0;m<60;m++){ const opt=document.createElement("option"); opt.value=m; opt.textContent=m.toString().padStart(2,'0'); selectMinute.appendChild(opt);}
        }

        populateTimeDropdowns(fromHourSelect, fromMinuteSelect);
        populateTimeDropdowns(toHourSelect, toMinuteSelect);

        // ---------- Calculate hours ----------
        function calculateHours(fromH, fromM, toH, toM){
            let startMinutes = fromH*60 + fromM;
            let endMinutes = toH*60 + toM;
            let diff = endMinutes - startMinutes;
            if(diff < 0) diff += 24*60;
            const hours = Math.floor(diff/60);
            const minutes = diff % 60;
            return { hours, minutes };
        }

        function updateHours(){
            const fromH = parseInt(fromHourSelect.value || 0);
            const fromM = parseInt(fromMinuteSelect.value || 0);
            const toH = parseInt(toHourSelect.value || 0);
            const toM = parseInt(toMinuteSelect.value || 0);
            const { hours, minutes } = calculateHours(fromH, fromM, toH, toM);
            hoursDisplay.textContent = `Hours: ${hours}h ${minutes}m`;
        }

        [fromHourSelect, fromMinuteSelect, toHourSelect, toMinuteSelect].forEach(el=>el.addEventListener("change", updateHours));

        // ---------- Render Table ----------
      function renderTable(){
    const userEntries = schedule.filter(e => e.worker === user.name);
    if(!userEntries.length){ 
        tableContainer.innerHTML="<p>No schedule entries.</p>"; 
        return; 
    }

    // Sort by month order, then by date
    const MONTH_ORDER = ["Janvāris","Februāris","Marts","Aprīlis","Maijs","Jūnijs",
                         "Jūlijs","Augusts","Septembris","Octobris","Novemberis","Decemberis"];
    
    userEntries.sort((a,b)=>{
        const monthDiff = MONTH_ORDER.indexOf(a.month) - MONTH_ORDER.indexOf(b.month);
        if(monthDiff !== 0) return monthDiff;
        return a.date - b.date; // sort by date within the month
    });

    let html="<table><tr><th>Month</th><th>Date</th><th>Car</th><th>From</th><th>To</th><th>Hours</th><th>Action</th></tr>";
    userEntries.forEach((e, index)=>{
        html+=`<tr>
            <td>${e.month}</td>
            <td>${e.date}</td>
            <td>${e.car}</td>
            <td>${e.fromTime}</td>
            <td>${e.toTime}</td>
            <td>${e.hours}</td>
            <td><button class="deleteEntryBtn" data-index="${index}">Delete</button></td>
        </tr>`;
    });
    html+="</table>"; 
    tableContainer.innerHTML=html;

    // Add event listeners for delete buttons
    document.querySelectorAll(".deleteEntryBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
            const idx = Number(btn.dataset.index);
            // Find the actual index in the full schedule array
            const entryToDelete = userEntries[idx];
            const scheduleIndex = schedule.findIndex(e => 
                e.worker === entryToDelete.worker &&
                e.month === entryToDelete.month &&
                e.date === entryToDelete.date &&
                e.car === entryToDelete.car &&
                e.fromTime === entryToDelete.fromTime &&
                e.toTime === entryToDelete.toTime
            );
            if(scheduleIndex !== -1 && confirm("Are you sure you want to delete this entry?")){
                schedule.splice(scheduleIndex, 1);
                localStorage.setItem("schedule", JSON.stringify(schedule));
                renderTable();
            }
        });
    });
}

        renderTable();

        // ---------- Form Submission ----------
        scheduleForm.addEventListener("submit", function(e){
            e.preventDefault();

            const month = monthSelect.value;
            const date = dateSelect.value;
            const car = carSelect.value;
            const fromH = parseInt(fromHourSelect.value);
            const fromM = parseInt(fromMinuteSelect.value);
            const toH = parseInt(toHourSelect.value);
            const toM = parseInt(toMinuteSelect.value);

            const { hours, minutes } = calculateHours(fromH, fromM, toH, toM);
            const fromTime = `${fromH.toString().padStart(2,'0')}:${fromM.toString().padStart(2,'0')}`;
            const toTime = `${toH.toString().padStart(2,'0')}:${toM.toString().padStart(2,'0')}`;

            const entry = { 
    month, 
    worker: user.name, 
    date, 
    car, 
    fromTime, 
    toTime, 
    hours: `${hours}h ${minutes}m`
};

schedule.unshift(entry);  // <-- NEW
localStorage.setItem("schedule", JSON.stringify(schedule));

renderTable();
scheduleForm.reset();
hoursDisplay.textContent = "Hours: 0h 0m";
        });
    </script>
</body>
</html>