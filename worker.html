<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darbinieks</title>
    <style>
    body { 
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
        background-color: #f0f2f5; 
        padding: 30px; 
        color: #333; 
        line-height: 1.5;
    }

    h2, h3 { color: #1a202c; margin-bottom: 20px; }

    /* Galvenais konteiners */
    .admin-container { 
        background: white; 
        padding: 30px; 
        border-radius: 15px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        margin-bottom: 30px; 
    }

    /* Filtru sadaļa */
    .filter-section { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 15px; 
        align-items: flex-end; 
        background: #f8fafc; 
        padding: 20px; 
        border-radius: 12px; 
        border: 1px solid #e2e8f0;
        margin-bottom: 25px;
    }

    .filter-group { display: flex; flex-direction: column; gap: 5px; }
    .filter-group label { font-size: 0.85rem; font-weight: 600; color: #64748b; }

    select, input { 
        padding: 10px 15px; 
        border-radius: 8px; 
        border: 1px solid #cbd5e1; 
        background-color: white; 
        font-size: 14px; 
        outline: none; 
        min-width: 160px; 
        transition: border-color 0.2s;
    }

    select:focus, input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    /* Pogas */
    button { 
        padding: 10px 20px; 
        border-radius: 8px; 
        border: none; 
        font-weight: 600; 
        cursor: pointer; 
        transition: all 0.2s ease; 
        font-size: 14px;
    }

    button:active { transform: translateY(1px); }

    .btn-clear { background: #94a3b8; color: white; }
    .btn-clear:hover { background: #64748b; }

    .btn-logout { background: #ef4444; color: white; float: right; }
    .btn-logout:hover { background: #dc2626; }

    /* Tabulas dizains */
    #tableContainer { 
        background: white; 
        border-radius: 12px; 
        overflow: hidden; 
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    table { 
        border-collapse: collapse; 
        width: 100%; 
        background: white; 
    }

    th { 
        background: #f8fafc; 
        color: #475569; 
        font-weight: 600; 
        text-transform: uppercase; 
        font-size: 12px; 
        letter-spacing: 0.05em; 
        padding: 16px 20px; 
        border-bottom: 2px solid #e2e8f0;
        text-align: center;
    }

    td { 
        padding: 14px 20px; 
        border-bottom: 1px solid #f1f5f9; 
        text-align: center; 
        font-size: 14px;
    }

    /* Zebra stils un Hover */
    tbody tr:nth-child(even) { background-color: #fdfdfd; }
    tbody tr:hover { background-color: #f1f5f9; }

    /* Summu rinda tabulas apakšā */
    tfoot tr { 
        background: #f8fafc !important; 
        font-weight: bold; 
        border-top: 2px solid #e2e8f0; 
    }
    
    tfoot td { color: #1e293b; padding: 18px 20px; }

    /* Resursu krāsas */
    .oil-text { color: #7c3aed; font-weight: bold; }
    .fuel-text { color: #ea580c; font-weight: bold; }
    .hours-text { font-weight: bold; color: #0f172a; }

    /* Summary info bloks virs tabulas */
    .summary-bar {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        font-size: 15px;
        background: #ffffff;
        padding: 15px;
        border-radius: 10px;
        border-left: 5px solid #3b82f6;
    }
</style>
</head>
<body>
    <div class="card">
        <h2 id="welcome"></h2>
        <div id="status">Statuss: Gaidīšana</div>
        <div id="startTimeDisplay" style="color: green; font-weight: bold;"></div>

        <div>
            <button id="AtWork">ESMU DARBĀ</button>
            <button id="LeaveWork">DODOS PROJĀM</button>
        </div>

        <div id="workControls">
            <select id="car" required><option value="">-- Izvēlies mašīnu --</option></select>
            <select id="object" required><option value="">-- Izvēlies objektu --</option></select>
            <select id="work" required><option value="">-- Izvēlies darba veidu --</option></select>
            
            <button id="startBtn" style="display:none;">Sākt darbu</button>
            <button id="stopBtn" style="display:none;">Beigt darbu</button>

            <button id="Ella" class="oil-btn" style="display:none;">Pieleju Eļļu</button>
            <button id="Degviela" class="fuel-btn" style="display:none;">Pielej Degvielu</button>
        </div>

        <div id="resourceModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
            <div style="background:white; padding:25px; border-radius:12px; width:90%; max-width:400px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                <h3 id="modalTitle" style="margin-top:0;">Pievienot resursu</h3>
                <label>Izvēlies mašīnu:</label>
                <select id="modalCarSelect" style="width:100%; padding:10px; margin: 10px 0 20px 0; border-radius:8px; border:1px solid #ccc;"></select>
                <label>Ievadi litrus:</label>
                <input type="number" id="modalAmountInput" step="0.01" placeholder="0.00" style="width:100%; padding:10px; margin: 10px 0 20px 0; border-radius:8px; border:1px solid #ccc; box-sizing: border-box;">
                <div style="display:flex; gap:10px;">
                    <button id="modalCancel" style="flex:1; background:#6c757d; color:white;">Atcelt</button>
                    <button id="modalSave" style="flex:1; background:#28a745; color:white;">Saglabāt</button>
                </div>
            </div>
        </div>

        <button id="logoutBtn">Izrakstīties</button>
    </div>

    <h3 style="text-align: center; margin-top: 30px;">Tavi pēdējie ieraksti:</h3>
    <div id="tableContainer"></div>

<script>
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!user) { window.location.href = "index.html"; } 
    else if (user.role === "admin") { window.location.href = "admin.html"; }

    document.getElementById("welcome").textContent = `Darbinieks: ${user.name}`;

    const carSelect = document.getElementById("car");
    const objectSelect = document.getElementById("object");
    const workSelect = document.getElementById("work");
    const tableContainer = document.getElementById("tableContainer");
    let currentResourceType = ""; 

    // --- MODAL LOGIC ---
    function openResourceModal(type) {
        currentResourceType = type;
        document.getElementById("modalTitle").innerText = type === "Ella" ? "Eļļas pieliešana" : "Degvielas uzpilde";
        const modalSelect = document.getElementById("modalCarSelect");
        
        // Copy car options from main select
        modalSelect.innerHTML = carSelect.innerHTML; 
        
        // If worker has already selected a car in the main UI, use it. 
        // Otherwise, let them pick in the modal.
        if (carSelect.value) {
            modalSelect.value = carSelect.value;
        }
        
        document.getElementById("resourceModal").style.display = "flex";
    }

    document.getElementById("Ella").onclick = () => openResourceModal("Ella");
    document.getElementById("Degviela").onclick = () => openResourceModal("Degviela");
    document.getElementById("modalCancel").onclick = () => {
        document.getElementById("resourceModal").style.display = "none";
        document.getElementById("modalAmountInput").value = "";
    };

    document.getElementById("modalSave").onclick = async () => {
        const auto = document.getElementById("modalCarSelect").value;
        const litri = document.getElementById("modalAmountInput").value;
        if (!auto) return alert("Izvēlies mašīnu!");
        if (!litri || litri <= 0) return alert("Ievadi derīgu litru daudzumu!");

        try {
            const res = await fetch('/api/update-resources', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ worker_name: user.name, car: auto, type: currentResourceType, amount: litri })
            });

            if (res.ok) {
                alert("Dati saglabāti!");
                document.getElementById("resourceModal").style.display = "none";
                document.getElementById("modalAmountInput").value = "";
                loadWorkerData();
            } else { 
                const errText = await res.text();
                alert("Kļūda: " + errText); 
            }
        } catch (err) { alert("Savienojuma kļūda."); }
    };

    // --- DATA LOADING ---
    function fillSelect(selectEl, data, defaultText) {
        const currentVal = selectEl.value;
        selectEl.innerHTML = `<option value="">${defaultText}</option>`;
        data.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item; opt.textContent = item;
            selectEl.appendChild(opt);
        });
        selectEl.value = currentVal;
    }

    async function loadWorkerData() {
        try {
            const [cRes, oRes, wRes, sRes] = await Promise.all([
                fetch('/api/cars'), fetch('/api/objects'), fetch('/api/work-types'), fetch('/api/schedule')
            ]);
            const cars = await cRes.json();
            const objects = await oRes.json();
            const workTypes = await wRes.json();
            const allSchedule = await sRes.json();

            fillSelect(carSelect, cars, "-- Izvēlies mašīnu --");
            fillSelect(objectSelect, objects, "-- Izvēlies objektu --");
            fillSelect(workSelect, workTypes, "-- Izvēlies darba veidu --");

            const activeJob = allSchedule.find(e => e.worker_name === user.name && !e.beigu_laiks);
            const shiftStartTime = localStorage.getItem(`shift_start_${user.name}`);

            if (activeJob) {
                document.getElementById("startBtn").style.display = "none";
                document.getElementById("LeaveWork").style.display = "none";
                document.getElementById("stopBtn").style.display = "block";
                [carSelect, objectSelect, workSelect].forEach(s => s.disabled = true);
                carSelect.value = activeJob.car;
                objectSelect.value = activeJob.objekts || "";
                workSelect.value = activeJob.darbs || "";
                document.getElementById("status").innerHTML = `Strādā: <b>${activeJob.objekts}</b> (${activeJob.car})`;
                document.getElementById("startTimeDisplay").innerText = `Sāki: ${activeJob.sākuma_laiks}`;
            } else {
                [carSelect, objectSelect, workSelect].forEach(s => s.disabled = false);
                document.getElementById("startBtn").style.display = shiftStartTime ? "block" : "none";
                document.getElementById("stopBtn").style.display = "none";
                document.getElementById("status").textContent = shiftStartTime ? "Statuss: Maiņa sākta" : "Statuss: Gaidīšana";
                document.getElementById("startTimeDisplay").innerText = "";
            }

            // --- BUTTON VISIBILITY LOGIC ---
            const isShiftStarted = !!shiftStartTime;
            document.getElementById("AtWork").style.display = isShiftStarted ? "none" : "block";
            document.getElementById("LeaveWork").style.display = isShiftStarted ? "block" : "none";
            
            // Show resource buttons if shift is started (even if no active job)
            document.getElementById("Ella").style.display = isShiftStarted ? "block" : "none";
            document.getElementById("Degviela").style.display = isShiftStarted ? "block" : "none";

            renderTable(allSchedule.filter(e => e.worker_name === user.name));
        } catch (err) { console.error(err); }
    }

    document.getElementById("AtWork").onclick = () => {
        localStorage.setItem(`shift_start_${user.name}`, new Date().toISOString());
        loadWorkerData();
    };

    document.getElementById("LeaveWork").onclick = async () => {
        if (!confirm("Beigt darba dienu?")) return;
        const tagad = new Date();
        const shiftStartRaw = localStorage.getItem(`shift_start_${user.name}`);
        let stundas = 0;
        if (shiftStartRaw) { stundas = ((tagad - new Date(shiftStartRaw)) / 3600000).toFixed(2); }

        const data = {
            darbinieks: user.name,
            datums: tagad.toLocaleDateString('lv-LV'),
            sāka_darbu: shiftStartRaw ? new Date(shiftStartRaw).toLocaleTimeString('lv-LV') : "--",
            beidza_darbu: tagad.toLocaleTimeString('lv-LV'),
            month: new Intl.DateTimeFormat('lv-LV', { month: 'long' }).format(tagad),
            stundas: parseFloat(stundas) || 0
        };

        await fetch('/api/darba-stundas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        localStorage.removeItem(`shift_start_${user.name}`);
        window.location.reload();
    };

    document.getElementById("startBtn").onclick = async () => {
        if (!carSelect.value || !objectSelect.value || !workSelect.value) return alert("Aizpildi laukus!");
        const now = new Date();
        await fetch('/api/start-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                worker_name: user.name, car: carSelect.value, objekts: objectSelect.value, 
                darbs: workSelect.value, start_time: `${now.toLocaleDateString('lv-LV')} ${now.toLocaleTimeString('lv-LV')}` 
            })
        });
        loadWorkerData();
    };

    document.getElementById("stopBtn").onclick = async () => {
        if (!confirm("Beigt darbu?")) return;
        const now = new Date();
        await fetch('/api/stop-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ worker_name: user.name, end_time: `${now.toLocaleDateString('lv-LV')} ${now.toLocaleTimeString('lv-LV')}` })
        });
        loadWorkerData();
    };

    function renderTable(data) {
        if (!data || !data.length) { tableContainer.innerHTML = "<p style='padding:15px;'>Nav ierakstu.</p>"; return; }
        let html = `<table><tr><th>Auto</th><th>Objekts</th><th>Darbs</th><th>Sākums</th><th>Beigas</th><th>Eļļa</th><th>Degv.</th><th>Stundas</th></tr>`;
        data.slice().reverse().forEach(e => {
            html += `<tr>
                <td>${e.car}</td>
                <td>${e.objekts || '-'}</td>
                <td>${e.darbs || '-'}</td>
                <td>${e.sākuma_laiks || '-'}</td>
                <td>${e.beigu_laiks || 'Aktīvs'}</td>
                <td style="color:#6f42c1; font-weight:bold;">${e.pielietā_eļļa || 0} L</td>
                <td style="color:#fd7e14; font-weight:bold;">${e.pielietā_degviela || 0} L</td>
                <td>${e.hours ? e.hours + ' h' : '-'}</td>
            </tr>`;
        });
        tableContainer.innerHTML = html + "</table>";
    }

    document.getElementById("logoutBtn").onclick = () => {
        localStorage.removeItem("loggedInUser");
        window.location.href = "index.html";
    };

    loadWorkerData();
</script>
</body>
</html>
