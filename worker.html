<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darbinieks</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
        
        /* Galvenā karte */
        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            max-width: 800px; 
            margin: 0 auto;
        }

        h2 { margin-top: 0; color: #2c3e50; }

        /* Statusa josla */
        #status { margin-bottom: 10px; font-size: 1.1em; }
        #startTimeDisplay { margin-bottom: 20px; font-size: 0.95em; }

        /* Kontroles bloks (Selecti un Pogas) */
        #workControls { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            align-items: center; 
            padding: 20px; 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Select elementu stils (līdzīgs admin mēneša filtram) */
        select { 
            padding: 10px 15px; 
            border-radius: 8px; 
            border: 1px solid #ced4da; 
            background-color: white; 
            font-size: 14px; 
            outline: none;
            min-width: 180px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:focus { border-color: #80bdff; }
        select:disabled { background-color: #e9ecef; cursor: not-allowed; }

        /* Pogas */
        button { 
            padding: 10px 20px; 
            border-radius: 8px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.2s ease;
        }

        #AtWork { background: #007bff; color: white; }
        #AtWork:hover { background: #0056b3; }

        #LeaveWork { background: #dc3545; color: white; display: none; margin-left: auto; }
        #LeaveWork:hover { background: #a71d2a; }

        #startBtn { background: #28a745; color: white; }
        #startBtn:hover { background: #218838; }

        #stopBtn { background: #ffc107; color: #212529; }
        #stopBtn:hover { background: #e0a800; }

        #logoutBtn { background: #6c757d; color: white; margin-top: 10px; }

        /* Tabula */
        table { border-collapse: collapse; margin-top: 25px; width: 100%; background: white; border-radius: 8px; overflow: hidden; }
        th { background: #f8f9fa; border-bottom: 2px solid #dee2e6; padding: 12px; font-weight: bold; }
        td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; }
        
        h3 { margin-top: 40px; border-left: 4px solid #007bff; padding-left: 10px; }

        @media (max-width: 600px) {
            #workControls { flex-direction: column; align-items: stretch; }
            select { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="welcome"></h2>
        <div id="status">Statuss: Gaidīšana</div>
        <div id="startTimeDisplay" style="color: green; font-weight: bold;"></div>

        <div style="display: flex; width: 100%; margin-bottom: 15px;">
            <button id="AtWork">ESMU DARBĀ</button>
            <button id="LeaveWork">DODOS PROJĀM</button>
        </div>

        <div id="workControls">
            <select id="car" required>
                <option value="">-- Izvēlies mašīnu --</option>
            </select>
            <select id="object" required>
                <option value="">-- Izvēlies objektu --</option>
            </select>
            <select id="work" required>
                <option value="">-- Izvēlies darba veidu --</option>
            </select>
            
            <button id="startBtn" style="display:none;">Sākt darbu</button>
            <button id="stopBtn" style="display:none;">Beigt darbu</button>
        </div>

        <button id="logoutBtn">Logout</button>
    </div>

    <h3>Tavi pēdējie ieraksti:</h3>
    <div id="tableContainer"></div>

<script>
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!user || user.role !== "worker") {
        window.location.href = "index.html";
    }
    document.getElementById("welcome").textContent = `Darbinieks: ${user.name}`;

    const carSelect = document.getElementById("car");
    const objectSelect = document.getElementById("object");
    const workSelect = document.getElementById("work");
    const tableContainer = document.getElementById("tableContainer");

    // --- PALĪGFUNKCIJAS ---
    function fillSelect(selectEl, data, defaultText) {
        const currentVal = selectEl.value;
        selectEl.innerHTML = `<option value="">${defaultText}</option>`;
        data.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item;
            opt.textContent = item;
            selectEl.appendChild(opt);
        });
        selectEl.value = currentVal;
    }

    // --- DATU IELĀDE ---
    async function loadWorkerData() {
        try {
            const [cRes, oRes, wRes, sRes] = await Promise.all([
                fetch('/api/cars'),
                fetch('/api/objects'),
                fetch('/api/work-types'),
                fetch('/api/schedule')
            ]);
            
            const cars = await cRes.json();
            const objects = await oRes.json();
            const workTypes = await wRes.json();
            const allSchedule = await sRes.json();

            fillSelect(carSelect, cars, "-- Izvēlies mašīnu --");
            fillSelect(objectSelect, objects, "-- Izvēlies objektu --");
            fillSelect(workSelect, workTypes, "-- Izvēlies darba veidu --");

            const activeJob = allSchedule.find(e => e.worker_name === user.name && !e.beigu_laiks);
            const shiftStartTime = localStorage.getItem(`shift_start_${user.name}`);

            // UI STĀVOKĻA VADĪBA
            if (activeJob) {
                document.getElementById("startBtn").style.display = "none";
                document.getElementById("stopBtn").style.display = "block";
                [carSelect, objectSelect, workSelect].forEach(s => s.disabled = true);
                carSelect.value = activeJob.car;
                objectSelect.value = activeJob.objekts || "";
                workSelect.value = activeJob.darbs || "";
                document.getElementById("status").innerHTML = `Strādā: <b>${activeJob.objekts}</b> (${activeJob.car})`;
                document.getElementById("startTimeDisplay").innerText = `Sāki: ${activeJob.sākuma_laiks}`;
            } else {
                [carSelect, objectSelect, workSelect].forEach(s => s.disabled = false);
                document.getElementById("startBtn").style.display = shiftStartTime ? "block" : "none";
                document.getElementById("stopBtn").style.display = "none";
                document.getElementById("status").textContent = shiftStartTime ? "Statuss: Maiņa sākta" : "Statuss: Gaidīšana";
                document.getElementById("startTimeDisplay").innerText = "";
            }

            // Maiņas pogu redzamība
            if (shiftStartTime || activeJob) {
                document.getElementById("AtWork").style.display = "none";
                document.getElementById("LeaveWork").style.display = "block";
            } else {
                document.getElementById("AtWork").style.display = "block";
                document.getElementById("LeaveWork").style.display = "none";
            }

            renderTable(allSchedule.filter(e => e.worker_name === user.name));
        } catch (err) {
            console.error("Datu ielādes kļūda:", err);
        }
    }

    // --- POGU NOTIKUMI ---

    document.getElementById("AtWork").onclick = () => {
        localStorage.setItem(`shift_start_${user.name}`, new Date().toISOString());
        loadWorkerData(); // Pārlādējam UI
    };

    document.getElementById("LeaveWork").onclick = async () => {
        const currentSchedule = await fetch('/api/schedule').then(r => r.json());
        const activeJob = currentSchedule.find(e => e.worker_name === user.name && !e.beigu_laiks);
        
        if (activeJob) {
            alert("Kļūda: Tev vēl ir aktīvs darbs! Pabeidz to, pirms dodies prom.");
            return;
        }

        if (!confirm("Vai tiešām vēlies beigt darba dienu?")) return;

        const tagad = new Date();
        const shiftStart = localStorage.getItem(`shift_start_${user.name}`);
        let nostradatasStundas = "0.00";
        
        if (shiftStart) {
            const diffMs = tagad - new Date(shiftStart);
            nostradatasStundas = (diffMs / 3600000).toFixed(2);
        }

        try {
            const response = await fetch('/api/darba-stundas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    darbinieks: user.name,
                    datums: tagad.toLocaleDateString('lv-LV'),
                    sāka_darbu: shiftStart ? new Date(shiftStart).toLocaleTimeString('lv-LV') : "--",
                    beidza_darbu: tagad.toLocaleTimeString('lv-LV'),
                    month: new Intl.DateTimeFormat('lv-LV', { month: 'long' }).format(tagad),
                    stundas: nostradatasStundas + " h"
                })
            });

            if (response.ok) {
                localStorage.removeItem(`shift_start_${user.name}`);
                alert("Darba diena noslēgta!");
                location.reload(); 
            }
        } catch (err) {
            alert("Servera kļūda!");
        }
    };

    document.getElementById("startBtn").onclick = async () => {
        if (!carSelect.value || !objectSelect.value || !workSelect.value) {
            return alert("Aizpildi visus laukus!");
        }
        const now = new Date();
        const fullTimestamp = `${now.toLocaleDateString('lv-LV')} ${now.toLocaleTimeString('lv-LV')}`;
        
        const res = await fetch('/api/start-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                worker_name: user.name, 
                car: carSelect.value,
                objekts: objectSelect.value,
                darbs: workSelect.value,
                start_time: fullTimestamp 
            })
        });
        if (res.ok) loadWorkerData();
    };

    document.getElementById("stopBtn").onclick = async () => {
        if (!confirm("Beigt darbu?")) return;
        const now = new Date();
        const fullTimestamp = `${now.toLocaleDateString('lv-LV')} ${now.toLocaleTimeString('lv-LV')}`;
        const res = await fetch('/api/stop-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ worker_name: user.name, end_time: fullTimestamp })
        });
        if (res.ok) loadWorkerData();
    };

    function renderTable(data) {
        if (!data || !data.length) { tableContainer.innerHTML = "Nav ierakstu."; return; }
        let html = `<table><tr><th>Auto</th><th>Objekts</th><th>Darbs</th><th>Sākums</th><th>Beigas</th><th>Stundas</th></tr>`;
        data.slice().reverse().forEach(e => {
            html += `<tr>
                <td>${e.car}</td>
                <td>${e.objekts || '-'}</td>
                <td>${e.darbs || '-'}</td>
                <td>${e.sākuma_laiks || '-'}</td>
                <td>${e.beigu_laiks || 'Aktīvs'}</td>
                <td>${e.hours ? e.hours + ' h' : '-'}</td>
            </tr>`;
        });
        tableContainer.innerHTML = html + "</table>";
    }

    document.getElementById("logoutBtn").onclick = () => {
        localStorage.removeItem("loggedInUser");
        window.location.href = "index.html";
    };

    loadWorkerData();
</script>
</body>
</html>
