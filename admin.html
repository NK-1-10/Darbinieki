<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panelis</title>
    <style>
        /* PAMATA STILS: Nosaka lapas fonu, tekstus un vispÄrÄ“jo izkÄrtojumu */
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: #f4f6f1; color: #0f1a14; padding: 20px; }
        h2, h3 { color: #2c3e50; margin-top: 20px; }

        /* REÅ½Ä¢IS: Izvieto iestatÄ«jumu blokus (Darbinieki, MaÅ¡Ä«nas utt.) divÄs kolonnÄs */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 900px; margin-bottom: 30px; }
        
        /* DROPDOWN BLOKI: Stils "details" elementiem (izvÄ“lnÄ“m, kas atveras) */
        details.pogas { background: #ffffff; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
        summary { cursor: pointer; font-weight: bold; padding: 15px; background: #f8f9fa; list-style: none; border-bottom: 1px solid #eee; }
        .content { padding: 15px; }

        /* POGAS UN SARAKSTI: Elementi iestatÄ«jumu iekÅ¡pusÄ“ */
        button { padding: 8px 15px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor: pointer; transition: 0.2s; }
        button:hover { background: #f0f0f0; }
        ul { list-style: none; padding: 0; margin-top: 10px; }
        li { background: #fdfdfd; margin-bottom: 5px; padding: 8px 12px; border-radius: 5px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        li button { background: #fee; color: #c33; border-color: #fcc; font-size: 12px; }

        /* FILTRI UN KONTROLES: AugÅ¡Ä“jÄ josla meklÄ“Å¡anai un kÄrtoÅ¡anai */
        #filters, .admin-top-bar { background: #fff; border: 1px solid #ccc; padding: 20px; border-radius: 10px; display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; align-items: flex-end; }
        #totalHoursDisplay { background: #eef2eb; padding: 10px 15px; border-radius: 8px; border: 1px solid #c3d9c3; font-weight: bold; }

        /* TABULAS IZKÄ€RTOJUMS: Izvieto abas tabulas blakus */
        #tables-layout { display: flex; gap: 20px; align-items: flex-start; }
        .table-box { background: #fff; border: 1px solid #ccc; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table { border-collapse: collapse; width: 100%; font-size: 14px; }
        th { background: #f1f3f5; padding: 12px; border-bottom: 2px solid #dee2e6; text-align: center; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
    </style>
</head>
<body>

<h2>IestatÄ«jumi</h2>

<div class="grid-container">
    <details class="pogas">
        <summary>ğŸ‘· Darbinieki</summary>
        <div class="content">
            <button id="addWorkerBtn">â• Pievienot darbinieku</button>
            <ul id="workerList"></ul>
        </div>
    </details>

    <details class="pogas">
        <summary>ğŸš— MaÅ¡Ä«nas</summary>
        <div class="content">
            <button id="addCarBtn">â• Pievienot maÅ¡Ä«nu</button>
            <ul id="carList"></ul>
        </div>
    </details>
    
    <details class="pogas">
        <summary>âš’ï¸ Darba veidi</summary>
        <div class="content">
            <button id="addWorkBtn">â• Pievienot veidu</button>
            <ul id="workList"></ul>
        </div>
    </details>

    <details class="pogas">
        <summary>ğŸ“ Objekti</summary>
        <div class="content">
            <button id="addObjectBtn">â• Pievienot objektu</button>
            <ul id="objectList"></ul>
        </div>
    </details>
</div>

<h3>MeklÄ“Å¡anas filtri</h3>
<div id="filters">
    <label>MÄ“nesis: <select id="filterMonth"><option value="">Visi</option></select></label>
    <label>Darbinieks: <select id="filterWorker"><option value="">Visi</option></select></label>
    <label>Diena: <select id="filterDate"><option value="">Visi</option></select></label>
    <label>MaÅ¡Ä«na: <select id="filterCar"><option value="">Visi</option></select></label>
    <button id="clearFilters">NotÄ«rÄ«t filtrus</button>
</div>

<div class="admin-top-bar">
    <div>
        <label>KÄrtot pÄ“c:</label>
        <select id="sortBy">
            <option value="">Nekas</option>
            <option value="date">Datums</option>
            <option value="worker_name">Darbinieks</option>
            <option value="car">MaÅ¡Ä«na</option>
            <option value="hours">Stundas</option>
        </select>
    </div>
    <div id="totalHoursDisplay">
        KopÄ: <span id="totalHoursValue">0.00</span> h
    </div>
</div>

<div id="tables-layout">
    <div style="flex: 2;">
        <h3>Darba Gaitas Atskaite</h3>
        <div id="tableContainer" class="table-box"></div>
    </div>

    <div style="flex: 1;">
        <h3>Resursi (EÄ¼Ä¼a/Degviela)</h3>
        <div id="oilContainer" class="table-box"></div>
    </div>
</div>

<script>
    // 1. KONSTANTES: MÄ“neÅ¡u secÄ«ba pareizai kÄrtoÅ¡anai
    const MONTH_ORDER = ["JanvÄris","FebruÄris","Marts","AprÄ«lis","Maijs","JÅ«nijs","JÅ«lijs","Augusts","Septembris","Oktobris","Novembris","Decembris"];
    
    // 2. GLOBÄ€LIE MAINÄªGIE: Å eit glabÄsies visi dati no datubÄzes
    let workers = [], cars = [], schedule = [], works_types = [], objects = [];

    // 3. DATU IELÄ€DE: GalvenÄ funkcija, kas paÅ†em datus no API
    async function loadData() {
        try {
            const [wRes, cRes, sRes, wtRes, oRes] = await Promise.all([
                fetch('/api/workers'), fetch('/api/cars'), fetch('/api/schedule'),
                fetch('/api/work-types'), fetch('/api/objects')
            ]);
            
            workers = await wRes.json();
            cars = await cRes.json();
            schedule = await sRes.json();
            works_types = await wtRes.json();
            objects = await oRes.json();
            
            // PÄ“c ielÄdes sazÄ«mÄ“jam visus sarakstus un filtrus
            renderSettings();
            fillFilters();
            renderTables(); 
        } catch (err) { console.error("Datu ielÄdes kÄ¼Å«da:", err); }
    }

    // 4. IESTATÄªJUMU RENDERÄ’Å ANA: Izveido sarakstus ar "DzÄ“st" pogÄm
    function renderSettings() {
        const renderList = (id, data, deleteFn) => {
            document.getElementById(id).innerHTML = data.map(item => {
                const name = typeof item === 'object' ? item.name : item;
                return `<li><span>${name}</span><button onclick="${deleteFn}('${name}')">DzÄ“st</button></li>`;
            }).join("");
        };

        renderList("workerList", workers, "deleteWorker");
        renderList("carList", cars, "deleteCar");
        renderList("workList", works_types, "deleteWorkType");
        renderList("objectList", objects, "deleteObject");
    }

    // 5. FILTRU AIZPILDÄªÅ ANA: Saliek unikÄlas vÄ“rtÄ«bas dropdown izvÄ“lnÄ“s
    function fillFilters() {
        const fill = (id, list) => {
            const select = document.getElementById(id);
            const current = select.value;
            const unique = [...new Set(list)].filter(Boolean).sort();
            select.innerHTML = '<option value="">Visi</option>' + unique.map(v => `<option value="${v}">${v}</option>`).join("");
            select.value = current;
        };

        fill("filterMonth", schedule.map(e => e.month));
        fill("filterWorker", workers.map(w => w.name));
        fill("filterCar", cars);
        fill("filterDate", schedule.map(e => e.date ? e.date.split('.')[0] : null));
    }

    // 6. GALVENÄ€ TABULU FUNKCIJA: FiltrÄ“, kÄrto un parÄda datus abÄs tabulÄs
    function renderTables() {
        // FiltrÄ“Å¡anas loÄ£ika
        let filtered = schedule.filter(e => {
            const day = e.date ? e.date.split('.')[0] : "";
            return (!document.getElementById("filterMonth").value || e.month === document.getElementById("filterMonth").value) &&
                   (!document.getElementById("filterWorker").value || e.worker_name === document.getElementById("filterWorker").value) &&
                   (!document.getElementById("filterDate").value || day === document.getElementById("filterDate").value) &&
                   (!document.getElementById("filterCar").value || e.car === document.getElementById("filterCar").value);
        });

        // KÄrtoÅ¡anas loÄ£ika
        const sortKey = document.getElementById("sortBy").value;
        if (sortKey) {
            filtered.sort((a, b) => {
                if (sortKey === 'hours') return (parseFloat(a.hours) || 0) - (parseFloat(b.hours) || 0);
                return String(a[sortKey] || "").localeCompare(String(b[sortKey] || ""), 'lv');
            });
        }

        // AprÄ“Ä·inÄm kopsummu
        const total = filtered.reduce((sum, item) => sum + (parseFloat(item.hours) || 0), 0);
        document.getElementById("totalHoursValue").textContent = total.toFixed(2);

        // ZÄ«mÄ“jam Darba Atskaites tabulu
        let workHtml = `<table><tr><th>Datums</th><th>Darbinieks</th><th>MaÅ¡Ä«na</th><th>Stundas</th></tr>`;
        workHtml += filtered.map(e => `<tr>
            <td>${e.date || '-'}</td>
            <td>${e.worker_name}</td>
            <td>${e.car}</td>
            <td><strong>${e.hours || '0'}</strong></td>
        </tr>`).join("");
        document.getElementById("tableContainer").innerHTML = workHtml + "</table>";

        // ZÄ«mÄ“jam Resursu tabulu (tikai tÄs rindas, kur ir eÄ¼Ä¼a vai degviela)
        let oilHtml = `<table><tr><th>Datums</th><th>EÄ¼Ä¼a (L)</th><th>Degviela (L)</th></tr>`;
        const resursi = filtered.filter(e => e.pielietÄ_eÄ¼Ä¼a || e.pielietÄ_degviela);
        oilHtml += resursi.map(e => `<tr>
            <td><small>${e.date || '-'}</small></td>
            <td style="color:blue;">${e.pielietÄ_eÄ¼Ä¼a || '0'}</td>
            <td style="color:orange;">${e.pielietÄ_degviela || '0'}</td>
        </tr>`).join("");
        document.getElementById("oilContainer").innerHTML = resursi.length ? oilHtml + "</table>" : "<p style='padding:10px;'>Nav datu</p>";
    }

    // 7. NOTIKUMU KLAUSÄªTÄ€JI: ReaÄ£Ä“ uz lietotÄja darbÄ«bÄm
    ["filterMonth", "filterWorker", "filterDate", "filterCar", "sortBy"].forEach(id => {
        document.getElementById(id).addEventListener("change", renderTables);
    });

    document.getElementById("clearFilters").onclick = () => {
        ["filterMonth", "filterWorker", "filterDate", "filterCar", "sortBy"].forEach(id => document.getElementById(id).value = "");
        renderTables();
    };

    // 8. PIEVIENOÅ ANAS FUNKCIJAS: NosÅ«ta jaunos datus uz serveri
    async function addItem(url, data) {
        await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        loadData();
    }

    document.getElementById("addWorkerBtn").onclick = () => {
        const name = prompt("VÄrds:");
        const pass = prompt("Parole:");
        if(name && pass) addItem('/api/workers', { name, temp_password: pass });
    };

    document.getElementById("addCarBtn").onclick = () => {
        const name = prompt("MaÅ¡Ä«nas nr:");
        if(name) addItem('/api/cars', { name });
    };

    document.getElementById("addWorkBtn").onclick = () => {
        const name = prompt("Darba veids:");
        if(name) addItem('/api/work-types', { name });
    };

    document.getElementById("addObjectBtn").onclick = () => {
        const name = prompt("Objekta nosaukums:");
        if(name) addItem('/api/objects', { name });
    };

    // 9. DZÄ’Å ANAS FUNKCIJAS
    async function deleteItem(url) {
        if(confirm("Vai tieÅ¡Äm dzÄ“st?")) {
            await fetch(url, { method: 'DELETE' });
            loadData();
        }
    }
    function deleteWorker(n) { deleteItem(`/api/workers/${encodeURIComponent(n)}`); }
    function deleteCar(n) { deleteItem(`/api/cars/${encodeURIComponent(n)}`); }
    function deleteWorkType(n) { deleteItem(`/api/work-types/${encodeURIComponent(n)}`); }
    function deleteObject(n) { deleteItem(`/api/objects/${encodeURIComponent(n)}`); }

    // PALAIÅ½AM VISU
    loadData();
</script>
</body>
</html>
