<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panelis</title>
    <style>
        /* Pamata iestatÄ«jumi */
        body { 
            font-family: sans-serif; 
            margin: 0; 
            background-color: #f4f4f9
            color: #333;
            padding: 20px; 
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        h2, h3 { margin-top: 30px; text-align: left; color: #2c3e50; }
        
        /* ReÅ¾Ä£a konteiners (2x2 stils) */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 900px;
            margin-bottom: 30px;
        }

        /* KvadrÄtu (details) stils */
        details.pogas {
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 100% !important;
            max-width: none !important;
            overflow: hidden;
            transition: box-shadow 0.3s;
        }

        details.pogas:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        summary { 
            cursor: pointer; 
            font-weight: bold; 
            padding: 15px; 
            background: #f8f9fa;
            border-bottom: 1px solid transparent;
            list-style: none;
        }

        details[open] summary { border-bottom: 1px solid #eee; background: #eef2eb; }

        /* IekÅ¡Ä“jais saturs blokos */
        .content { padding: 15px; }

        /* Pogas stils */
        button { 
            padding: 8px 15px; 
            border-radius: 6px; 
            border: 1px solid #ccc; 
            background: #fff; 
            cursor: pointer; 
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover { background: #f0f0f0; }

        /* Saraksti iekÅ¡ details */
        ul { list-style: none; padding: 0; margin-top: 10px; }
        li { 
            background: #fdfdfd; 
            margin-bottom: 5px; 
            padding: 8px 12px; 
            border-radius: 5px; 
            border: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 14px;
        }

        li button { padding: 4px 8px; font-size: 12px; background: #fee; border-color: #fcc; color: #c33; }
        li button:hover { background: #fdd; }

        /* Filtru sadaÄ¼a */
        #filters { 
            background: #fff; 
            border: 1px solid #ccc; 
            padding: 20px; 
            border-radius: 10px; 
            width: 100%; 
            max-width: 860px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            align-items: flex-end;
        }

        #filters label { display: flex; flex-direction: column; font-size: 13px; font-weight: bold; color: #555; }

        select { 
            padding: 8px; 
            border-radius: 6px; 
            border: 1px solid #ccc; 
            background: #fff; 
            margin-top: 5px;
            min-width: 140px;
        }

        /* DarbÄ«bu josla un Tabula */
        .action-bar { margin: 20px 0; }
        
        #table-wrapper { 
            background: #fff; 
            border: 1px solid #ccc; 
            border-radius: 10px; 
            overflow: hidden; 
            width: 100%; 
            max-width: 1000px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .table-controls { 
            background: #f8f9fa; 
            padding: 15px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
            gap: 15px;
        }

        #totalHoursDisplay { 
            background: #eef2eb; 
            padding: 10px 15px; 
            border-radius: 8px; 
            border: 1px solid #c3d9c3; 
            font-weight: bold;
            color: #2c5d2c;
        }

        table { border-collapse: collapse; width: 100%; font-size: 14px; }
        th { background: #f1f3f5; padding: 12px; border-bottom: 2px solid #dee2e6; color: #495057; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }

        /* MobilajÄm ierÄ«cÄ“m */
        @media (max-width: 600px) {
            .grid-container { grid-template-columns: 1fr; }
            #filters { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

<h2>IestatÄ«jumi</h2>

<div class="grid-container">
    <details class="pogas">
        <summary>ğŸ‘· Darbinieki</summary>
        <div class="content">
            <button id="addWorkerBtn">â• Pievienot darbinieku</button>
            <ul id="workerList"></ul>
        </div>
    </details>

    <details class="pogas">
        <summary>ğŸš— MaÅ¡Ä«nas</summary>
        <div class="content">
            <button id="addCarBtn">â• Pievienot maÅ¡Ä«nu</button>
            <ul id="carList"></ul>
        </div>
    </details>
    
    <details class="pogas">
        <summary>âš’ï¸ Darba veidi</summary>
        <div class="content">
            <button id="addWorkBtn">â• Pievienot veidu</button>
            <ul id="workList"></ul>
        </div>
    </details>

    <details class="pogas">
        <summary>ğŸ“ Objekti</summary>
        <div class="content">
            <button id="addObjectBtn">â• Pievienot objektu</button>
            <ul id="objectList"></ul>
        </div>
    </details>
</div>

<h3>MeklÄ“Å¡anas filtri</h3>

<div id="filters">
    <label>MÄ“nesis: <select id="filterMonth"><option value="">Visi</option></select></label>
    <label>Darbinieks: <select id="filterWorker"><option value="">Visi</option></select></label>
    <label>Datums: <select id="filterDate"><option value="">Visi</option></select></label>
    <label>MaÅ¡Ä«na: <select id="filterCar"><option value="">Visi</option></select></label>
    <button id="clearFilters" style="background: #eee;">NotÄ«rÄ«t filtrus</button>
</div>

<div class="action-bar">
    <button id="clearTableBtn" style="background:#ff6666; color:white; border:none; padding: 10px 20px;">IztÄ«rÄ«t visu tabulu</button>
</div>

<div id="table-wrapper">
    <div class="table-controls">
        <div style="display: flex; gap: 10px;">
            <label>KÄrtot: <select id="sortBy"><option value="">Nekas</option><option value="month">MÄ“nesis</option><option value="worker_name">Darbinieks</option><option value="date">Datums</option><option value="car">MaÅ¡Ä«na</option><option value="hours">Stundas</option></select></label>
            <label>Tad: <select id="sortBy2"><option value="">Nekas</option><option value="month">MÄ“nesis</option><option value="worker_name">Darbinieks</option><option value="date">Datums</option><option value="car">MaÅ¡Ä«na</option><option value="hours">Stundas</option></select></label>
        </div>
        <div id="totalHoursDisplay">
            KopÄ: <span id="totalHoursValue">0.00</span> h
        </div>
    </div>
    <div id="tableContainer"></div>
</div>

<script>
    // Tava nemainÄ«tÄ JS loÄ£ika ar nelieliem renderÄ“Å¡anas uzlabojumiem (Content DIV ielikÅ¡ana)
    const MONTH_ORDER = ["JanvÄris","FebruÄris","Marts","AprÄ«lis","Maijs","JÅ«nijs","JÅ«lijs","Augusts","Septembris","Oktobris","Novembris","Decembris"];
    const workerList = document.getElementById("workerList");
    const carList = document.getElementById("carList");
    const workList = document.getElementById("workList");
    const objectList = document.getElementById("objectList");
    const tableContainer = document.getElementById("tableContainer");
    const filterMonth = document.getElementById("filterMonth");
    const filterWorker = document.getElementById("filterWorker");
    const filterDate = document.getElementById("filterDate");
    const filterCar = document.getElementById("filterCar");
    const sortBy1 = document.getElementById("sortBy");
    const sortBy2 = document.getElementById("sortBy2");
    
    let workers = [];
    let cars = [];
    let schedule = [];
    let works_types = [];
    let objects = [];

   async function loadData() {
    try {
        const [wRes, cRes, sRes, wtRes, oRes] = await Promise.all([
            fetch('/api/workers'), fetch('/api/cars'), fetch('/api/schedule'),
            fetch('/api/work-types'), fetch('/api/objects')
        ]);
        workers = await wRes.json();
        cars = await cRes.json();
        schedule = await sRes.json();
        works_types = await wtRes.json();
        objects = await oRes.json();
        
        renderWorkers();
        renderCars();
        renderWork();
        renderObject();
        
        // 1. AizpildÄm mÄ“neÅ¡u filtru
        fillFilter(filterMonth, schedule.map(e => e.month));

        // 2. LABOJUMS: Izvelkam tikai dienas (piemÄ“ram, no "05.02.2026" dabÅ«jam "05")
        const days = schedule.map(e => {
            if (!e.date) return null;
            return e.date.split('.')[0]; // PaÅ†emam skaitli pirms pirmÄ punkta
        }).filter(Boolean); // NoÅ†emam tukÅ¡os ierakstus

        // AizpildÄm filtru ar unikÄlÄm dienÄm un sakÄrtojam tÄs augoÅ¡Ä secÄ«bÄ
        fillFilter(filterDate, [...new Set(days)].sort((a, b) => a - b));

        renderTable();
    } catch (err) { console.error(err); }
}

    function renderWorkers() {
        workers.sort((a,b) => a.name.localeCompare(b.name, 'lv'));
        workerList.innerHTML = workers.map(w => `<li><span><strong>${w.name}</strong> ${w.temp_password ? `<span style="color:#888; font-size:12px;">(${w.temp_password})</span>`:''}</span><button onclick="deleteWorker('${w.name}')">DzÄ“st</button></li>`).join("");
        fillFilter(filterWorker, workers.map(w => w.name));
    }

    function renderCars() {
        cars.sort((a,b) => a.localeCompare(b, 'lv'));
        carList.innerHTML = cars.map(c => `<li><strong>${c}</strong><button onclick="deleteCar('${c}')">DzÄ“st</button></li>`).join("");
        fillFilter(filterCar, cars);
    }

    function renderWork() {
        works_types.sort((a,b) => a.localeCompare(b, 'lv'));
        workList.innerHTML = works_types.map(w => `<li><strong>${w}</strong><button onclick="deleteWorkType('${w}')">DzÄ“st</button></li>`).join("");
    }

    function renderObject() {
        objects.sort((a,b) => a.localeCompare(b, 'lv'));
        objectList.innerHTML = objects.map(o => `<li><strong>${o}</strong><button onclick="deleteObject('${o}')">DzÄ“st</button></li>`).join("");
    }

    function fillFilter(select, list) {
        const current = select.value;
        const uniqueValues = [...new Set(list)].filter(Boolean);
        select.innerHTML = `<option value="">Visi</option>` + uniqueValues.map(v => `<option value="${v}">${v}</option>`).join("");
        select.value = current;
    }

    function renderTable() {
    let filtered = schedule.filter(e => {
        // Izvelkam dienu no katra ieraksta datuma (piem. "05")
        const dayOnly = e.date ? e.date.split('.')[0] : ""; 

        return (!filterMonth.value || e.month === filterMonth.value) &&
               (!filterWorker.value || e.worker_name === filterWorker.value) &&
               (!filterDate.value || dayOnly === filterDate.value) && // SALÄªDZINÄ€M TIKAI DIENU
               (!filterCar.value || e.car === filterCar.value);
    });

        const total = filtered.reduce((sum, item) => sum + (parseFloat(item.hours) || 0), 0);
        document.getElementById("totalHoursValue").textContent = total.toFixed(2);

        const sortLogic = (a, b, key) => {
            if (!key) return 0;
            if (key === 'month') return MONTH_ORDER.indexOf(a.month) - MONTH_ORDER.indexOf(b.month);
            if (key === 'date') return parseInt(a.date) - parseInt(b.date);
            if (key === 'hours') return parseFloat(a.hours) - parseFloat(b.hours);
            return String(a[key] || "").localeCompare(String(b[key] || ""));
        };
        filtered.sort((a, b) => sortLogic(a, b, sortBy1.value) || sortLogic(a, b, sortBy2.value) || b.id - a.id);

        if (!filtered.length) { tableContainer.innerHTML = "<p style='padding:20px;'>Nav ierakstu.</p>"; return; }

        let html = `<table><tr><th>MÄ“nesis</th><th>Darbinieks</th><th>Datums</th><th>MaÅ¡Ä«na</th><th>Objekts</th><th>Darbs</th><th>KopÅ¡</th><th>LÄ«dz</th><th>Stundas</th></tr>`;
        filtered.forEach(e => {
            html += `<tr>
                <td>${e.month || '-'}</td>
                <td>${e.worker_name}</td>
                <td>${e.date}</td>
                <td>${e.car}</td>
                <td>${e.objekts || '-'}</td>
                <td>${e.darbs || '-'}</td>
                <td>${e.sÄkuma_laiks || '-'}</td>
                <td>${e.beigu_laiks || 'AktÄ«vs'}</td>
                <td><strong>${e.hours || '-'}</strong></td>
            </tr>`;
        });
        tableContainer.innerHTML = html + `</table>`;
    }

    // Event Listeners un API izsaukumi (KÄ iepriekÅ¡)
    [filterMonth, filterWorker, filterDate, filterCar, sortBy1, sortBy2].forEach(el => el.addEventListener("change", renderTable));
    
    document.getElementById("clearFilters").onclick = () => {
        [filterMonth, filterWorker, filterDate, filterCar, sortBy1, sortBy2].forEach(el => el.value = "");
        renderTable();
    };

    document.getElementById("addWorkBtn").onclick = async () => {
        const name = prompt("Darba veids:");
        if(name) { await fetch('/api/work-types', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: name.trim() }) }); loadData(); }
    };

    document.getElementById("addObjectBtn").onclick = async () => {
        const name = prompt("Objekts:");
        if(name) { await fetch('/api/objects', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: name.trim() }) }); loadData(); }
    };

    async function deleteWorkType(name) { if(confirm(`DzÄ“st ${name}?`)) { await fetch(`/api/work-types/${encodeURIComponent(name)}`, { method: 'DELETE' }); loadData(); } }
    async function deleteObject(name) { if(confirm(`DzÄ“st ${name}?`)) { await fetch(`/api/objects/${encodeURIComponent(name)}`, { method: 'DELETE' }); loadData(); } }
    
    document.getElementById("addWorkerBtn").onclick = async () => {
        const name = prompt("VÄrds:");
        const pass = prompt("Parole:");
        if(name && pass) { await fetch('/api/workers', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: name.trim(), temp_password: pass.trim() }) }); loadData(); }
    };

    document.getElementById("addCarBtn").onclick = async () => {
        const name = prompt("MaÅ¡Ä«na:");
        if(name) { await fetch('/api/cars', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: name.trim() }) }); loadData(); }
    };

    async function deleteWorker(name) { if(confirm(`DzÄ“st ${name}?`)) { await fetch(`/api/workers/${encodeURIComponent(name)}`, { method: 'DELETE' }); loadData(); } }
    async function deleteCar(name) { if(confirm(`DzÄ“st ${name}?`)) { await fetch(`/api/cars/${encodeURIComponent(name)}`, { method: 'DELETE' }); loadData(); } }

    document.getElementById("clearTableBtn").onclick = async () => {
        if (confirm("DZÄ’ST VISU?")) { await fetch('/api/schedule', { method: 'DELETE' }); loadData(); }
    };

    loadData();
</script>
</body>
</html>
