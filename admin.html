<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panelis</title>
   <style>
    /* Pamata lapa */
body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: #f4f6f1; color: #0f1a14; padding: 15px; font-size: 13px; }
       h2, h3 { color: #2c3e50; margin: 10px 0; font-size: 1.2em; }

    /* IestatÄ«jumu bloki */
    .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 900px; margin-bottom: 15px; }
    details.pogas { background: #ffffff; border: 1px solid #ccc; border-radius: 6px; }
    summary { cursor: pointer; font-weight: bold; padding: 8px 12px; background: #f8f9fa; list-style: none; border-bottom: 1px solid #eee; }
    .content { padding: 8px; }

    /* Filtru joslas */
    #filters, .admin-top-bar { background: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px; align-items: flex-end; }
    
    /* MAKSIMÄ€LI TIEVA TABULA */
    #tables-layout { display: flex; gap: 15px; align-items: flex-start; width: 100%; }
    table { border-collapse: collapse; width: 100%; font-size: 12px; line-height: 1; margin-bottom: 10px; }
    th { background: #f1f3f5; padding: 4px 8px; border-bottom: 1px solid #dee2e6; text-align: left; }
    td { padding: 2px 8px; border-bottom: 1px solid #f0f0f0; white-space: nowrap; }
    .table-box { background: #fff; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
    
    tr:hover { background-color: #f8f9fa; }
    
    .hours-col { font-weight: bold; text-align: right; }
</style>
</head>
<body>

<h2>IestatÄ«jumi</h2>

<div class="grid-container">
    <details class="pogas">
        <summary>ğŸ‘· Darbinieki</summary>
        <div class="content">
            <button id="addWorkerBtn">â• Pievienot darbinieku</button>
            <ul id="workerList"></ul>
        </div>
    </details>

    <details class="pogas">
        <summary>ğŸš— MaÅ¡Ä«nas</summary>
        <div class="content">
            <button id="addCarBtn">â• Pievienot maÅ¡Ä«nu</button>
            <ul id="carList"></ul>
        </div>
    </details>
    
    <details class="pogas">
        <summary>âš’ï¸ Darba veidi</summary>
        <div class="content">
            <button id="addWorkBtn">â• Pievienot veidu</button>
            <ul id="workList"></ul>
        </div>
    </details>

    <details class="pogas">
        <summary>ğŸ“ Objekti</summary>
        <div class="content">
            <button id="addObjectBtn">â• Pievienot objektu</button>
            <ul id="objectList"></ul>
        </div>
    </details>
</div>

<h3>MeklÄ“Å¡anas filtri</h3>
<div id="filters">
    <label>MÄ“nesis: <select id="filterMonth"><option value="">Visi</option></select></label>
    <label>Darbinieks: <select id="filterWorker"><option value="">Visi</option></select></label>
    <label>Diena: <select id="filterDate"><option value="">Visi</option></select></label>
    <label>MaÅ¡Ä«na: <select id="filterCar"><option value="">Visi</option></select></label>
    <button id="clearFilters">NotÄ«rÄ«t filtrus</button>
</div>

<div class="admin-top-bar">
    <div>
        <label>KÄrtot pÄ“c:</label>
        <select id="sortBy">
            <option value="">Nekas</option>
            <option value="date">Datums</option>
            <option value="worker_name">Darbinieks</option>
            <option value="car">MaÅ¡Ä«na</option>
            <option value="hours">Stundas</option>
        </select>
    </div>
    <div id="totalHoursDisplay">
        KopÄ nostrÄdÄts: <span id="totalHoursValue">0.00</span> h
    </div>
</div>

<div id="tables-layout">
    <div style="flex: 3;">
        <h3> Darba Gaitas Atskaite </h3>
        <div id="tableContainer" class="table-box"></div>
    </div>

    <div style="flex: 1;">
        <h3> EÄ¼Ä¼a un degvela </h3>
        <div id="oilContainer" class="table-box"></div>
    </div>

    <div style="flex: 1;">
    <h3> Darba laika uzskaite </h3>
    <div id="newTableContainer" class="table-box"></div> </div>
    
</div>

<script>
    const MONTH_ORDER = ["JanvÄris","FebruÄris","Marts","AprÄ«lis","Maijs","JÅ«nijs","JÅ«lijs","Augusts","Septembris","Oktobris","Novembris","Decembris"];
    let workers = [], cars = [], schedule = [], works_types = [], objects = [], daySummary = []; // Pievieno daySummary

   async function loadData() {
    try {
        const [wRes, cRes, sRes, wtRes, oRes, dsRes] = await Promise.all([
            fetch('/api/workers'), fetch('/api/cars'), fetch('/api/schedule'),
            fetch('/api/work-types'), fetch('/api/objects'), 
            fetch('/api/darba-stundas') // PIEPRASÄªJUMS JAUNAJAM API
        ]);
        
        workers = await wRes.json();
        cars = await cRes.json();
        schedule = await sRes.json();
        works_types = await wtRes.json();
        objects = await oRes.json();
        daySummary = await dsRes.json(); // SAGLABÄ€JAM DATUS
        
        renderSettings();
        fillFilters();
        renderTables(); 
    } catch (err) { console.error("Datu ielÄdes kÄ¼Å«da:", err); }
}

    function renderSettings() {
        const renderList = (id, data, deleteFn) => {
            document.getElementById(id).innerHTML = data.map(item => {
                const name = typeof item === 'object' ? item.name : item;
                return `<li><span>${name}</span><button onclick="${deleteFn}('${name}')">DzÄ“st</button></li>`;
            }).join("");
        };
        renderList("workerList", workers, "deleteWorker");
        renderList("carList", cars, "deleteCar");
        renderList("workList", works_types, "deleteWorkType");
        renderList("objectList", objects, "deleteObject");
    }

    function fillFilters() {
        const fill = (id, list) => {
            const select = document.getElementById(id);
            const current = select.value;
            const unique = [...new Set(list)].filter(Boolean).sort();
            select.innerHTML = '<option value="">Visi</option>' + unique.map(v => `<option value="${v}">${v}</option>`).join("");
            select.value = current;
        };
        fill("filterMonth", schedule.map(e => e.month));
        fill("filterWorker", schedule.map(e => e.worker_name));
        fill("filterCar", schedule.map(e => e.car));
        fill("filterDate", schedule.map(e => e.date ? e.date.split('.')[0] : null));
    }

    // --- GALVENÄ€ RENDERÄ’Å ANAS FUNKCIJA ---
    function renderTables() {
        // FiltrÄ“Å¡ana
        let filtered = schedule.filter(e => {
            const day = e.date ? e.date.split('.')[0] : "";
            return (!document.getElementById("filterMonth").value || e.month === document.getElementById("filterMonth").value) &&
                   (!document.getElementById("filterWorker").value || e.worker_name === document.getElementById("filterWorker").value) &&
                   (!document.getElementById("filterDate").value || day === document.getElementById("filterDate").value) &&
                   (!document.getElementById("filterCar").value || e.car === document.getElementById("filterCar").value);
        });

        // KÄrtoÅ¡ana
        const sortKey = document.getElementById("sortBy").value;
        if (sortKey) {
            filtered.sort((a, b) => {
                if (sortKey === 'hours') return (parseFloat(b.hours) || 0) - (parseFloat(a.hours) || 0);
                if (sortKey === 'date') return new Date(b.date.split('.').reverse().join('-')) - new Date(a.date.split('.').reverse().join('-'));
                return String(a[sortKey] || "").localeCompare(String(b[sortKey] || ""), 'lv');
            });
        }

        // Stundu kopsumma
        const total = filtered.reduce((sum, item) => sum + (parseFloat(item.hours) || 0), 0);
        document.getElementById("totalHoursValue").textContent = total.toFixed(2);

        // --- GALVENÄ€ TABULA (9 kolonnas kÄ attÄ“lÄ) ---
        let workHtml = `<table>
            <tr>
                <th>Datums</th>
                <th>MÄ“nesis</th>
                <th>MaÅ¡Ä«na</th>
                <th>Darbinieks</th>
                <th>Objekts</th>
                <th>Darbs</th>
                <th>KopÅ¡</th>
                <th>LÄ«dz</th>
                <th style="text-align:right;">Stundas</th>
            </tr>`;

        workHtml += filtered.map(e => `
            <tr>
                <td>${e.date || '-'}</td>
                <td>${e.month || '-'}</td>
                <td>${e.car || '-'}</td>
                <td>${e.worker_name || '-'}</td>
                <td>${e.objekts || '-'}</td>
                <td>${e.darbs || '-'}</td>
                <td>${e.sÄkuma_laiks || '-'}</td>
                <td>${e.beigu_laiks || '-'}</td>
                <td class="hours-col">${parseFloat(e.hours || 0).toFixed(2)}</td>
            </tr>`).join("");
        
        document.getElementById("tableContainer").innerHTML = workHtml + "</table>";

        // --- RESURSU TABULA ---
       // --- RESURSU TABULA (AtjauninÄta) ---
// --- RESURSU TABULA (AtjauninÄta) ---
        let oilHtml = `<table><tr><th>Datums</th><th>MaÅ¡Ä«na</th><th>Darbinieks</th><th>EÄ¼Ä¼a (L)</th><th>Degviela (L)</th></tr>`;

        // FiltrÄ“jam ierakstus, kuros ir jebkÄda eÄ¼Ä¼a vai degviela
        const resursi = filtered.filter(e => 
            (parseFloat(e.pielietÄ_eÄ¼Ä¼a) > 0 || parseFloat(e.pielietÄ_degviela) > 0 || 
             parseFloat(e.ella) > 0 || parseFloat(e.degviela) > 0)
        );

        oilHtml += resursi.map(e => {
            // SavÄcam datus no visÄm iespÄ“jamÄm kolonnÄm (savietojamÄ«bai)
            const e_litri = parseFloat(e.pielietÄ_eÄ¼Ä¼a || e.ella || 0);
            const d_litri = parseFloat(e.pielietÄ_degviela || e.degviela || 0);
            
            return `<tr>
                <td>${e.date || '-'}</td>
                <td>${e.car || '-'}</td>
                <td>${e.worker_name || '-'}</td>
                <td style="color:#d63384; font-weight:bold;">${e_litri > 0 ? e_litri.toFixed(2) : '-'}</td>
                <td style="color:#fd7e14; font-weight:bold;">${d_litri > 0 ? d_litri.toFixed(2) : '-'}</td>
            </tr>`;
        }).join("");

        document.getElementById("oilContainer").innerHTML = resursi.length ? oilHtml + "</table>" : "<p style='padding:15px;'>Nav resursu datu.</p>";
   
      // --- DARBA LAIKA UZSKAITES TABULA (JaunÄ) ---
        // --- DARBA LAIKA UZSKAITES TABULA (JaunÄ) ---
let summaryHtml = `<table>
    <tr>
        <th>Darbinieks</th>
        <th>Datums</th>
        <th>SÄkums</th>
        <th>Beigas</th>
        <th>MÄ“nesis</th>
        <th>Stundas</th>
    </tr>`;

summaryHtml += daySummary.map(s => `
    <tr>
        <td>${s.darbinieks}</td>
        <td>${s.datums}</td>
        <td>${s.sÄka_darbu || '-'}</td>
        <td>${s.beidza_darbu || '-'}</td>
        <td>${s.month || '-'}</td>
        <td style="font-weight:bold; color:#007bff;">${parseFloat(s.stundas || 0).toFixed(2)} h</td>
    </tr>`).join("");

// Ievietojam datus konteinerÄ
document.getElementById("newTableContainer").innerHTML = daySummary.length ? summaryHtml + "</table>" : "<p style='padding:10px;'>Nav ierakstu.</p>";
    } // Funkcijas renderTables beigas

    // Event Listeners
    ["filterMonth", "filterWorker", "filterDate", "filterCar", "sortBy"].forEach(id => {
        document.getElementById(id).addEventListener("change", renderTables);
    });

    document.getElementById("clearFilters").onclick = () => {
        ["filterMonth", "filterWorker", "filterDate", "filterCar", "sortBy"].forEach(id => document.getElementById(id).value = "");
        renderTables();
    };

    // PievienoÅ¡anas un dzÄ“Å¡anas funkcijas (izmantojot tavus API)
    async function addItem(url, data) {
        await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        loadData();
    }
    document.getElementById("addWorkerBtn").onclick = () => { const n = prompt("VÄrds:"); const p = prompt("Parole:"); if(n&&p) addItem('/api/workers', { name: n, temp_password: p }); };
    document.getElementById("addCarBtn").onclick = () => { const n = prompt("MaÅ¡Ä«nas nr:"); if(n) addItem('/api/cars', { name: n }); };
    document.getElementById("addWorkBtn").onclick = () => { const n = prompt("Darba veids:"); if(n) addItem('/api/work-types', { name: n }); };
    document.getElementById("addObjectBtn").onclick = () => { const n = prompt("Objekta nosaukums:"); if(n) addItem('/api/objects', { name: n }); };

    async function deleteItem(url) { if(confirm("DzÄ“st?")) { await fetch(url, { method: 'DELETE' }); loadData(); } }
    function deleteWorker(n) { deleteItem(`/api/workers/${encodeURIComponent(n)}`); }
    function deleteCar(n) { deleteItem(`/api/cars/${encodeURIComponent(n)}`); }
    function deleteWorkType(n) { deleteItem(`/api/work-types/${encodeURIComponent(n)}`); }
    function deleteObject(n) { deleteItem(`/api/objects/${encodeURIComponent(n)}`); }

    loadData();
</script>
</body>
</html>
