<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        h2, h3 { margin-top: 20px; }
        button { padding: 8px 12px; margin: 4px 0; border-radius: 6px; border: 1px solid #aaa; background: #e0e0e0; cursor: pointer; }
        button:hover { background: #d5d5d5; }
        ul { list-style: none; padding: 0; margin: 6px 0; max-width: 400px; }
        li { background:#fff; margin:6px 0; padding:8px 10px; border-radius:6px; border:1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        li span { flex-grow: 1; }
        .pw { color:#666; font-style:italic; margin-left:8px; }
        details { margin-bottom: 15px; background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 10px; max-width: 450px; }
        summary { cursor: pointer; font-weight: bold; padding: 4px; }
        table { border-collapse: collapse; margin-top: 20px; width: 100%; background: #fff; }
        th, td { border: 1px solid #333; padding: 6px 12px; text-align: center; }
        #filters { background: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 6px; max-width: 700px; margin-bottom: 15px; }
        select { padding: 4px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<h2>Pievienot darbiniekus un maÅ¡Ä«nas</h2>

<details open>
    <summary>ğŸ‘· Pievienot darbiniekus</summary>
    <button id="addWorkerBtn">â• Pievienot darbinieku</button>
    <ul id="workerList"></ul>
</details>

<details>
    <summary>ğŸš— Pievienot maÅ¡Ä«nas</summary>
    <button id="addCarBtn">â• pievienot maÅ¡Ä«nu</button>
    <ul id="carList"></ul>
</details>

<div style="text-align: right; margin-bottom: 10px;">
    <button id="clearTableBtn" style="background:#ff6666; color:white;">Clear Table</button>
</div>

<h3> Tabula</h3>

<div id="filters">
    <label>MÄ“nesis:
        <select id="filterMonth"><option value="">All</option></select>
    </label>

    <label>Darbinieks:
        <select id="filterWorker"><option value="">All</option></select>
    </label>

    <label>Datums:
        <select id="filterDate"><option value="">All</option></select>
    </label>

    <label>MaÅ¡Ä«na:
        <select id="filterCar"><option value="">All</option></select>
    </label>

    <br><br>

    <label>Sort By:
        <select id="sortBy">
            <option value="">None</option>
            <option value="month">Month</option>
            <option value="worker">Worker</option>
            <option value="date">Date</option>
            <option value="car">Car</option>
            <option value="hours">Hours</option>
        </select>
    </label>

    <button id="clearFilters"> Clear Filters</button>
</div>

<div id="tableContainer"></div>

<script>
    const MONTH_ORDER = ["JanvÄris","FebruÄris","Marts","AprÄ«lis","Maijs","JÅ«nijs",
                         "JÅ«lijs","Augusts","Septembris","Octobris","Novemberis","Decemberis"];

    // Elementi
    const workerList = document.getElementById("workerList");
    const carList = document.getElementById("carList");
    const tableContainer = document.getElementById("tableContainer");
    const filterMonth = document.getElementById("filterMonth");
    const filterWorker = document.getElementById("filterWorker");
    const filterDate = document.getElementById("filterDate");
    const filterCar = document.getElementById("filterCar");
    const sortBy = document.getElementById("sortBy");

    // Datu glabÄtuve (Å¡eit ielÄdÄ“sim datus no servera)
    let workers = [];
    let cars = [];
    let schedule = [];

    // 1. FUNKCIJA: IelÄdÄ“t visu no Railway datubÄzes
    async function loadData() {
        try {
            const [wRes, cRes, sRes] = await Promise.all([
                fetch('/api/workers'),
                fetch('/api/cars'),
                fetch('/api/schedule')
            ]);

            workers = await wRes.json();
            cars = await cRes.json();
            schedule = await sRes.json();

            renderWorkers();
            renderCars();
            renderTable();
        } catch (err) {
            console.error("KÄ¼Å«da ielÄdÄ“jot datus:", err);
        }
    }

    // 2. DARBINIEKU PIEVIENOÅ ANA (SÅ«ta uz Railway)
    document.getElementById("addWorkerBtn").onclick = async () => {
        const name = prompt("Ievadiet darbinieka vÄrdu:");
        if(!name || !name.trim()) return;
        const temp_password = prompt(`Ievadiet pagaidu paroli priekÅ¡ ${name}:`);
        if(!temp_password || !temp_password.trim()) return;

        const res = await fetch('/api/workers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: name.trim(), temp_password: temp_password.trim() })
        });

        if(res.ok) {
            alert("Darbinieks pievienots Railway!");
            loadData(); // PÄrlÄdÄ“ sarakstu
        }
    };

    // 3. MAÅ ÄªNU PIEVIENOÅ ANA (SÅ«ta uz Railway)
    document.getElementById("addCarBtn").onclick = async () => {
        const name = prompt("Ievadiet jaunu maÅ¡Ä«nu:");
        if(!name || !name.trim()) return;

        const res = await fetch('/api/cars', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: name.trim() })
        });

        if(res.ok) {
            alert("MaÅ¡Ä«na pievienota Railway!");
            loadData();
        }
    };

    // 4. VIZUALIZÄ€CIJA (Tava vecÄ loÄ£ika, bet pielÄgota)
    function renderWorkers() {
    // 1. Izveidojam sarakstu, pÄrbaudot katru darbinieku
    workerList.innerHTML = workers.map(w => {
        // PÄrbaudÄm, vai parole ir nomainÄ«ta (ir NULL vai teksts "NULL")
        const isChanged = !w.temp_password || w.temp_password === "NULL";
        
        // IzvÄ“lamies, ko rÄdÄ«t pie paroles
        const pwDisplay = isChanged 
            ? `<span style="color: #28a745; font-weight: bold;">âœ“ NomainÄ«ta</span>` 
            : `<span class="pw" style="color: #666;">(Temp: ${w.temp_password})</span>`;

        return `<li><strong>${w.name}</strong> ${pwDisplay}</li>`;
    }).join("");

    // 2. AtjauninÄm filtru
    fillFilter(filterWorker, workers.map(w => w.name));
}

    function renderCars() {
        carList.innerHTML = cars.map(c => `<li><strong>${c}</strong></li>`).join("");
        fillFilter(filterCar, cars);
    }

    function fillFilter(select, list) {
        const current = select.value;
        select.innerHTML = `<option value="">Visi</option>` + [...new Set(list)].map(v => `<option value="${v}">${v}</option>`).join("");
        select.value = current;
    }

    function renderTable() {
        let filtered = schedule.filter(e => {
            return (!filterMonth.value || e.month === filterMonth.value) &&
                   (!filterWorker.value || e.worker_name === filterWorker.value) &&
                   (!filterDate.value || String(e.date) === filterDate.value) &&
                   (!filterCar.value || e.car === filterCar.value);
        });

        // KÄrtoÅ¡ana
        const key = sortBy.value;
        if(key) {
            filtered.sort((a,b) => a[key] > b[key] ? 1 : -1);
        }

        if(!filtered.length) {
            tableContainer.innerHTML = "<p>Nav ierakstu.</p>";
            return;
        }

        let html = `<table><tr><th>MÄ“nesis</th><th>Darbinieks</th><th>Datums</th><th>MaÅ¡Ä«na</th><th>KopÅ¡</th><th>LÄ«dz</th><th>Stundas</th></tr>`;
        filtered.forEach(e => {
            html += `<tr><td>${e.month}</td><td>${e.worker_name}</td><td>${e.date}</td><td>${e.car}</td><td>${e.from_time}</td><td>${e.to_time}</td><td>${e.hours}</td></tr>`;
        });
        tableContainer.innerHTML = html + `</table>`;
    }

    // KlausÄ«tÄji filtriem
    [filterMonth, filterWorker, filterDate, filterCar, sortBy].forEach(el => el.addEventListener("change", renderTable));

    // SÄkam darbu
    loadData();
</script>
</body>
</html>
