<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panelis</title>
    <style>
        /* 1. LABOJUMS: MainÄm align-items uz flex-start, lai viss sÄktos no kreisÄs malas */
        body { 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; 
            margin: 0; 
            background: #f4f6f1; 
            color: #0f1a14; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            padding: 20px; 
        }

        #totalHoursDisplay { background: #eef2eb; padding: 10px 20px; border-radius: 8px; border: 1px solid #ccc; display: inline-block; }
        #totalHoursValue { color: #2c7a7b; }
        
        /* 2. LABOJUMS: Virsrakstiem noÅ†emam center */
        h2, h3 { margin-top: 20px; text-align: left; width: 100%; }
        
        button { padding: 8px 12px; margin: 4px 0; border-radius: 6px; border: 1px solid #aaa; background: #e0e0e0; cursor: pointer; }
        button:hover { background: #d5d5d5; }
        
        ul { list-style: none; padding: 0; margin: 6px 0; width: 100%; max-width: 400px; }
        li { background:#fff; margin:6px 0; padding:8px 10px; border-radius:6px; border:1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        
        .pw { color:#666; font-style:italic; margin-left:8px; font-size: 0.9em; }

        /* 3. LABOJUMS: Details un pogas klase */
        details { margin-bottom: 15px; background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 10px; width: 100%; max-width: 450px; }
        .pogas { text-align: left; }
        summary { cursor: pointer; font-weight: bold; padding: 4px; }

        /* 4. LABOJUMS: Filtru un tabulas novietojums */
        #filters { 
            background: #fff; border: 1px solid #ccc; padding: 15px; border-radius: 6px; 
            width: 100%; max-width: 750px; margin: 0 0 15px 0; 
            display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 10px; 
        }

        #table-wrapper { background: #fff; border: 1px solid #333; border-radius: 6px; overflow: hidden; margin-top: 20px; width: 100%; max-width: 900px; }
        .table-controls { background: #eee; padding: 10px; border-bottom: 1px solid #333; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: center; }
        th { background: #f9f9f9; }
        
        select { padding: 4px 6px; border-radius: 4px; }
        .action-bar { width: 100%; display: flex; justify-content: flex-start; margin: 10px 0; }
    </style>
</head>
<body>

<h2 style="text-align: left;">Pievienot darbiniekus un maÅ¡Ä«nas</h2>

<details class="pogas" open>
    <summary>ğŸ‘· Pievienot darbiniekus</summary>
    <button id="addWorkerBtn">â• Pievienot darbinieku</button>
    <ul id="workerList"></ul>
</details>

<details class="pogas">
    <summary>ğŸš— Pievienot maÅ¡Ä«nas</summary>
    <button id="addCarBtn">â• Pievienot maÅ¡Ä«nu</button>
    <ul id="carList"></ul>
</details>

<hr style="width: 100%; max-width: 750px; margin: 20px 0; border: 0; border-top: 1px solid #ccc;">

<h3>MeklÄ“Å¡anas filtri</h3>

<div id="filters">
    <label>MÄ“nesis: <select id="filterMonth"><option value="">Visi</option></select></label>
    <label>Darbinieks: <select id="filterWorker"><option value="">Visi</option></select></label>
    <label>Datums: <select id="filterDate"><option value="">Visi</option></select></label>
    <label>MaÅ¡Ä«na: <select id="filterCar"><option value="">Visi</option></select></label>
    <button id="clearFilters">NotÄ«rÄ«t filtrus</button>
</div>

<div class="action-bar">
    <button id="clearTableBtn" style="background:#ff6666; color:white; border:none;">Clear Table</button>
</div>

<div id="table-wrapper">
    <div class="table-controls">
        <label><strong>KÄrtot pÄ“c:</strong> 
            <select id="sortBy">
                <option value="">Nekas</option>
                <option value="month">MÄ“nesis</option>
                <option value="worker_name">Darbinieks</option>
                <option value="date">Datums</option>
                <option value="car">MaÅ¡Ä«na</option>
                <option value="hours">Stundas</option>
            </select>
        </label>
        <label><strong>KÄrtot pÄ“c:</strong> 
            <select id="sortBy2">
                <option value="">Nekas</option>
                <option value="month">MÄ“nesis</option>
                <option value="worker_name">Darbinieks</option>
                <option value="date">Datums</option>
                <option value="car">MaÅ¡Ä«na</option>
                <option value="hours">Stundas</option>
            </select>
        </label>
        <div id="totalHoursDisplay">
            KopÄ nostrÄdÄtÄs stundas: <span id="totalHoursValue">0.00</span> h
        </div>
    </div>
    <div id="tableContainer"></div>
</div>

<script>
    // Å eit paliek tava nemainÄ«tÄ loÄ£ika...
    const MONTH_ORDER = ["JanvÄris","FebruÄris","Marts","AprÄ«lis","Maijs","JÅ«nijs","JÅ«lijs","Augusts","Septembris","Oktobris","Novembris","Decembris"];
    const workerList = document.getElementById("workerList");
    const carList = document.getElementById("carList");
    const tableContainer = document.getElementById("tableContainer");
    const filterMonth = document.getElementById("filterMonth");
    const filterWorker = document.getElementById("filterWorker");
    const filterDate = document.getElementById("filterDate");
    const filterCar = document.getElementById("filterCar");
    const sortBy1 = document.getElementById("sortBy");
    const sortBy2 = document.getElementById("sortBy2");
    
    let workers = [];
    let cars = [];
    let schedule = [];

    async function loadData() {
        try {
            const [wRes, cRes, sRes] = await Promise.all([fetch('/api/workers'), fetch('/api/cars'), fetch('/api/schedule')]);
            if (!wRes.ok || !cRes.ok || !sRes.ok) throw new Error("NeizdevÄs iegÅ«t datus");
            workers = await wRes.json();
            cars = await cRes.json();
            schedule = await sRes.json();
            renderWorkers();
            renderCars();
            fillFilter(filterMonth, schedule.map(e => e.month));
            fillFilter(filterDate, schedule.map(e => e.date).sort((a,b) => a-b));
            renderTable();
        } catch (err) { console.error("KÄ¼Å«da:", err); }
    }

    function renderWorkers() {
        const sortedWorkers = [...workers].sort((a, b) => a.name.localeCompare(b.name, 'lv'));
        workerList.innerHTML = sortedWorkers.map(w => {
            const tempPassHtml = (w.temp_password && w.temp_password !== "NULL") ? `<span class="pw">(Temp: ${w.temp_password})</span>` : "";
            return `<li><span><strong>${w.name}</strong>${tempPassHtml}</span><button onclick="deleteWorker('${w.name}')">DzÄ“st</button></li>`;
        }).join("");
        fillFilter(filterWorker, sortedWorkers.map(w => w.name));
    }

    function renderCars() {
        const sortedCars = [...cars].sort((a, b) => a.localeCompare(b, 'lv'));
        carList.innerHTML = sortedCars.map(c => `<li><strong>${c}</strong><button onclick="deleteCar('${c}')">DzÄ“st</button></li>`).join("");
        fillFilter(filterCar, sortedCars);
    }

    function fillFilter(select, list) {
        const current = select.value;
        const uniqueValues = [...new Set(list)];
        select.innerHTML = `<option value="">Visi</option>` + uniqueValues.map(v => `<option value="${v}">${v}</option>`).join("");
        select.value = current;
    }

    function renderTable() {
        let filtered = schedule.filter(e => {
            return (!filterMonth.value || e.month === filterMonth.value) &&
            (!filterWorker.value || e.worker_name === filterWorker.value) &&
            (!filterDate.value || String(e.date) === filterDate.value) &&
            (!filterCar.value || e.car === filterCar.value);
        });
        const total = filtered.reduce((sum, item) => sum + (parseFloat(item.hours) || 0), 0);
        document.getElementById("totalHoursValue").textContent = total.toFixed(2);
        if (!sortBy1.value && !sortBy2.value) {
            filtered.sort((a, b) => b.id - a.id); 
        } else {
            const sortLogic = (a, b, key) => {
                if (!key) return 0;
                if (key === 'month') return MONTH_ORDER.indexOf(a.month) - MONTH_ORDER.indexOf(b.month);
                if (key === 'date') return parseInt(a.date) - parseInt(b.date);
                if (key === 'hours') return parseFloat(a.hours) - parseFloat(b.hours);
                return String(a[key] || "").localeCompare(String(b[key] || ""));
            };
            filtered.sort((a, b) => sortLogic(a, b, sortBy1.value) || sortLogic(a, b, sortBy2.value));
        }
        if (!filtered.length) { tableContainer.innerHTML = "<p style='padding:20px;'>Nav ierakstu.</p>"; return; }
        let html = `<table><tr><th>MÄ“nesis</th><th>Darbinieks</th><th>Datums</th><th>MaÅ¡Ä«na</th><th>KopÅ¡</th><th>LÄ«dz</th><th>Stundas</th></tr>`;
        filtered.forEach(e => {
            html += `<tr><td>${e.month || '-'}</td><td>${e.worker_name}</td><td>${e.date}</td><td>${e.car}</td><td>${e.sÄkuma_laiks || '-'}</td><td>${e.beigu_laiks || 'AktÄ«vs'}</td><td>${e.hours || '-'}</td></tr>`;
        });
        tableContainer.innerHTML = html + `</table>`;
    }

    [filterMonth, filterWorker, filterDate, filterCar, sortBy1, sortBy2].forEach(el => el.addEventListener("change", renderTable));
    document.getElementById("clearFilters").onclick = () => {
        [filterMonth, filterWorker, filterDate, filterCar, sortBy1, sortBy2].forEach(el => el.value = "");
        renderTable();
    };

    document.getElementById("addWorkerBtn").onclick = async () => {
        const name = prompt("Ievadiet darbinieka vÄrdu:");
        if(!name || !name.trim()) return;
        const temp_pass = prompt(`Ievadiet pagaidu paroli priekÅ¡ ${name}:`);
        if(!temp_pass || !temp_pass.trim()) return;
        const res = await fetch('/api/workers', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: name.trim(), temp_password: temp_pass.trim() }) });
        if(res.ok) { alert("Pievienots!"); loadData(); }
    };

    document.getElementById("addCarBtn").onclick = async () => {
        const name = prompt("Ievadiet jaunu maÅ¡Ä«nu:");
        if(!name || !name.trim()) return;
        const res = await fetch('/api/cars', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: name.trim() }) });
        if(res.ok) { alert("Pievienota!"); loadData(); }
    };

    async function deleteWorker(name) {
        if(!confirm(`DzÄ“st darbinieku ${name}?`)) return;
        const res = await fetch(`/api/workers/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if(res.ok) loadData();
    }

    async function deleteCar(name) {
        if (!confirm(`Vai tieÅ¡Äm vÄ“laties dzÄ“st maÅ¡Ä«nu ${name}?`)) return;
        try {
            const res = await fetch(`/api/cars/${encodeURIComponent(name)}`, { method: 'DELETE' });
            if (res.ok) loadData();
        } catch (err) { console.error(err); }
    }

    document.getElementById("clearTableBtn").onclick = async () => {
        if (confirm("Vai tieÅ¡Äm vÄ“laties izdzÄ“st VISUS ierakstus?")) {
            try {
                const res = await fetch('/api/schedule', { method: 'DELETE' });
                if (res.ok) { alert("NotÄ«rÄ«ts!"); loadData(); }
            } catch (err) { console.error(err); }
        }
    };

    loadData();
</script>
</body>
</html>
