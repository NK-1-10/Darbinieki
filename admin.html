<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panelis</title>
    <style>
        /* 1. PAMATA NOFORMÄ’JUMS */
        body { font-family: system-ui, -auto; margin: 0; background: #f4f6f1; color: #0f1a14; padding: 15px; font-size: 13px; }
        h2, h3 { color: #2c3e50; margin: 10px 0; font-size: 1.2em; }

        /* 2. IESTATÄªJUMU POGAS (Darbinieki, MaÅ¡Ä«nas utt.) */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 900px; margin-bottom: 15px; }
        details.pogas { background: #ffffff; border: 1px solid #ccc; border-radius: 6px; }
        summary { cursor: pointer; font-weight: bold; padding: 8px 12px; background: #f8f9fa; list-style: none; border-bottom: 1px solid #eee; }
        .content { padding: 8px; }
        ul { list-style: none; padding: 0; margin: 5px 0; }
        li { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px dotted #ccc; }

        /* 3. FILTRI UN JOSLAS */
        #filters, .admin-top-bar { background: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px; align-items: flex-end; }
        
        /* 4. MAKSIMÄ€LI TIEVAS TABULAS STILS */
        #tables-layout { display: flex; gap: 15px; align-items: flex-start; width: 100%; }
        .table-box { background: #fff; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; width: 100%; margin-bottom: 20px; }
        
        table { border-collapse: collapse; width: 100%; font-size: 12px; line-height: 1; }
        th { background: #f1f3f5; padding: 4px 8px; border-bottom: 1px solid #dee2e6; text-align: left; color: #495057; white-space: nowrap; }
        td { padding: 2px 8px; border-bottom: 1px solid #f0f0f0; text-align: left; white-space: nowrap; }
        tr:hover { background-color: #f8f9fa; }
        
        .hours-col { font-weight: bold; text-align: right; }
        .summary-row { background: #fdfdfd; font-weight: bold; }
    </style>
</head>
<body>

<h2>Admin Panelis</h2>

<div class="grid-container">
    <details class="pogas"><summary>ğŸ‘· Darbinieki</summary><div class="content"><button id="addWorkerBtn">â• Pievienot</button><ul id="workerList"></ul></div></details>
    <details class="pogas"><summary>ğŸš— MaÅ¡Ä«nas</summary><div class="content"><button id="addCarBtn">â• Pievienot</button><ul id="carList"></ul></div></details>
    <details class="pogas"><summary>âš’ï¸ Darbi</summary><div class="content"><button id="addWorkBtn">â• Pievienot</button><ul id="workList"></ul></div></details>
    <details class="pogas"><summary>ğŸ“ Objekti</summary><div class="content"><button id="addObjectBtn">â• Pievienot</button><ul id="objectList"></ul></div></details>
</div>

<h3>MeklÄ“Å¡anas filtri</h3>
<div id="filters">
    <label>MÄ“nesis: <select id="filterMonth"><option value="">Visi</option></select></label>
    <label>Darbinieks: <select id="filterWorker"><option value="">Visi</option></select></label>
    <button id="clearFilters">NotÄ«rÄ«t</button>
</div>

<div class="admin-top-bar">
    <div id="totalHoursDisplay">KopÄ nostrÄdÄts: <span id="totalHoursValue">0.00</span> h</div>
</div>

<div id="tables-layout">
    <div style="flex: 3;">
        <h3>ğŸ› ï¸ Darba Gaitas Atskaite (Uzdevumi)</h3>
        <div id="tableContainer" class="table-box"></div>
    </div>
    <div style="flex: 1;">
        <h3>â›½ Resursi</h3>
        <div id="oilContainer" class="table-box"></div>
    </div>
</div>

<div style="width: 100%;">
    <h3>ğŸ“… Darba dienas kopsavilkums (Iebrauca / Izbrauca)</h3>
    <div id="daySummaryContainer" class="table-box"></div>
</div>

<script>
    // GlobÄlie mainÄ«gie datiem
    let workers=[], cars=[], schedule=[], works_types=[], objects=[], daySummary=[];

    // 1. FUNKCIJA: Datu ielÄde no servera
    async function loadData() {
        try {
            const [w, c, s, wt, o, ds] = await Promise.all([
                fetch('/api/workers'), fetch('/api/cars'), fetch('/api/schedule'),
                fetch('/api/work-types'), fetch('/api/objects'), fetch('/api/darba-stundas')
            ]);
            
            workers = await w.json();
            cars = await c.json();
            schedule = await s.json();
            works_types = await wt.json();
            objects = await o.json();
            daySummary = await ds.json();
            
            renderSettings();
            fillFilters();
            renderTables(); 
        } catch (err) { console.error("KÄ¼Å«da ielÄdÄ“jot datus:", err); }
    }

    // 2. FUNKCIJA: Aizpilda iestatÄ«jumu sarakstus (dzÄ“Å¡anas pogas)
    function renderSettings() {
        const list = (id, data, del) => {
            document.getElementById(id).innerHTML = data.map(item => {
                const name = typeof item === 'object' ? item.name : item;
                return `<li>${name} <button onclick="${del}('${name}')">x</button></li>`;
            }).join("");
        };
        list("workerList", workers, "deleteWorker");
        list("carList", cars, "deleteCar");
        list("workList", works_types, "deleteWorkType");
        list("objectList", objects, "deleteObject");
    }

    // 3. FUNKCIJA: Aizpilda filtru izvÄ“lnes
    function fillFilters() {
        const monthSelect = document.getElementById("filterMonth");
        const uniqueMonths = [...new Set(schedule.map(e => e.month))];
        monthSelect.innerHTML = '<option value="">Visi</option>' + uniqueMonths.map(m => `<option value="${m}">${m}</option>`).join("");
        
        const workerSelect = document.getElementById("filterWorker");
        const uniqueWorkers = [...new Set(workers.map(w => w.name))];
        workerSelect.innerHTML = '<option value="">Visi</option>' + uniqueWorkers.map(w => `<option value="${w}">${w}</option>`).join("");
    }

    // 4. FUNKCIJA: GalvenÄ tabulu zÄ«mÄ“Å¡ana
    function renderTables() {
        const fMonth = document.getElementById("filterMonth").value;
        const fWorker = document.getElementById("filterWorker").value;

        // FiltrÄ“jam datus abÄm tabulÄm
        const filteredSchedule = schedule.filter(e => (!fMonth || e.month === fMonth) && (!fWorker || e.worker_name === fWorker));
        const filteredDays = daySummary.filter(e => (!fMonth || e.month === fMonth) && (!fWorker || e.darbinieks === fWorker));

        // ZÄ«mÄ“jam DARBU tabulu (9 kolonnas)
        let workHtml = `<table><tr><th>Datums</th><th>MÄ“nesis</th><th>MaÅ¡Ä«na</th><th>Darbinieks</th><th>Objekts</th><th>Darbs</th><th>KopÅ¡</th><th>LÄ«dz</th><th class="hours-col">Stundas</th></tr>`;
        workHtml += filteredSchedule.map(e => `<tr>
            <td>${e.date || '-'}</td><td>${e.month || '-'}</td><td>${e.car || '-'}</td><td>${e.worker_name || '-'}</td>
            <td>${e.objekts || '-'}</td><td>${e.darbs || '-'}</td><td>${e.sÄkuma_laiks || '-'}</td><td>${e.beigu_laiks || '-'}</td>
            <td class="hours-col">${parseFloat(e.hours || 0).toFixed(2)}</td>
        </tr>`).join("");
        document.getElementById("tableContainer").innerHTML = workHtml + "</table>";

        // ZÄ«mÄ“jam DIENAS KOPSAVILKUMA tabulu (JaunÄ)
        let dayHtml = `<table><tr><th>Darbinieks</th><th>Datums</th><th>Iebrauca</th><th>Izbrauca</th><th class="hours-col">KopÄ h</th></tr>`;
        dayHtml += filteredDays.slice().reverse().map(e => `<tr>
            <td><b>${e.darbinieks}</b></td><td>${e.datums}</td>
            <td style="color:green">${e.sÄka_darbu}</td><td style="color:red">${e.beidza_darbu}</td>
            <td class="hours-col">${parseFloat(e.stundas || 0).toFixed(2)}</td>
        </tr>`).join("");
        document.getElementById("daySummaryContainer").innerHTML = dayHtml + "</table>";

        // KopÄ“jo stundu aprÄ“Ä·ins (no darbiem)
        const total = filteredSchedule.reduce((sum, item) => sum + (parseFloat(item.hours) || 0), 0);
        document.getElementById("totalHoursValue").textContent = total.toFixed(2);
    }

    // Notikumu klausÄ«tÄji filtriem
    document.getElementById("filterMonth").onchange = renderTables;
    document.getElementById("filterWorker").onchange = renderTables;
    document.getElementById("clearFilters").onclick = () => { 
        document.getElementById("filterMonth").value = ""; 
        document.getElementById("filterWorker").value = ""; 
        renderTables(); 
    };

    loadData();
</script>
</body>
</html>
