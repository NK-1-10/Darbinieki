<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panelis</title>
    <style>
        /* VizuÄlais noformÄ“jums stundu skaitÄ«tÄjam un tabulai */
        #totalHoursDisplay { background: #eef2eb; padding: 10px 20px; border-radius: 8px; border: 1px solid #ccc; display: inline-block; }
        #totalHoursValue { color: #2c7a7b; }
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; margin: 0; background: #f4f6f1; color: #0f1a14; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        h2, h3 { margin-top: 20px; text-align: center; }
        button { padding: 8px 12px; margin: 4px 0; border-radius: 6px; border: 1px solid #aaa; background: #e0e0e0; cursor: pointer; }
        button:hover { background: #d5d5d5; }
        ul { list-style: none; padding: 0; margin: 6px auto; width: 100%; max-width: 400px; }
        li { background:#fff; margin:6px 0; padding:8px 10px; border-radius:6px; border:1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .pw { color:#666; font-style:italic; margin-left:8px; font-size: 0.9em; }
        details { margin: 0 auto 15px auto; background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 10px; width: 100%; max-width: 450px; text-align: center; }
        summary { cursor: pointer; font-weight: bold; padding: 4px; }
        #table-wrapper { background: #fff; border: 1px solid #333; border-radius: 6px; overflow: hidden; margin-top: 20px; width: 100%; max-width: 900px; }
        .table-controls { background: #eee; padding: 10px; border-bottom: 1px solid #333; display: flex; gap: 20px; align-items: center; justify-content: center; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: center; }
        th { background: #f9f9f9; }
        #filters { background: #fff; border: 1px solid #ccc; padding: 15px; border-radius: 6px; max-width: 750px; margin: 0 auto 15px auto; text-align: center; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        select { padding: 4px 6px; border-radius: 4px; }
        .action-bar { width: 100%; display: flex; justify-content: center; margin-bottom: 10px; }
        .pogas {
    text-align: left;        /* Teksts un pogas pa kreisi */
    margin-left: 0;          /* NodroÅ¡ina, ka nav nobÄ«des no malas */
    margin-right: auto;      /* PÄrÄ“jo brÄ«vo vietu atstÄj labajÄ pusÄ“ */
    display: block;          /* PÄrliecinÄmies, ka elements uzvedas kÄ bloks */
}

/* Ja gribi, lai arÄ« pogas iekÅ¡pusÄ“ nereaÄ£Ä“tu uz nekÄdu centrÄ“Å¡anu */
.pogas button {
    display: inline-block;
    margin: 5px 0;           /* Atstarpes starp pogÄm */
}
    </style>
</head>
<body>

<h2>Pievienot darbiniekus un maÅ¡Ä«nas</h2>

<details class="pogas">
    <summary>ğŸ‘· Pievienot darbiniekus</summary>
    <button id="addWorkerBtn">â• Pievienot darbinieku</button>
    <ul id="workerList"></ul>
</details>

<details class="pogas">
    <summary>ğŸš— Pievienot maÅ¡Ä«nas</summary>
    <button id="addCarBtn">â• Pievienot maÅ¡Ä«nu</button>
    <ul id="carList"></ul>
</details>

<div class="action-bar">
    <button id="clearTableBtn" style="background:#ff6666; color:white; border:none;">Clear Table</button>
</div>

<hr style="width: 100%; max-width: 750px; margin: 20px 0; border: 0; border-top: 1px solid #ccc;">

<h3>MeklÄ“Å¡anas filtri</h3>

<div id="filters">
    <label>MÄ“nesis: <select id="filterMonth"><option value="">Visi</option></select></label>
    <label>Darbinieks: <select id="filterWorker"><option value="">Visi</option></select></label>
    <label>Datums: <select id="filterDate"><option value="">Visi</option></select></label>
    <label>MaÅ¡Ä«na: <select id="filterCar"><option value="">Visi</option></select></label>
    <button id="clearFilters">NotÄ«rÄ«t filtrus</button>
</div>

<div id="table-wrapper">
    <div class="table-controls">
        <label><strong>KÄrtot pÄ“c:</strong> 
            <select id="sortBy">
                <option value="">Nekas</option>
                <option value="month">MÄ“nesis</option>
                <option value="worker_name">Darbinieks</option>
                <option value="date">Datums</option>
                <option value="car">MaÅ¡Ä«na</option>
                <option value="hours">Stundas</option>
            </select>
        </label>
        <label><strong>KÄrtot pÄ“c:</strong> 
            <select id="sortBy2">
                <option value="">Nekas</option>
                <option value="month">MÄ“nesis</option>
                <option value="worker_name">Darbinieks</option>
                <option value="date">Datums</option>
                <option value="car">MaÅ¡Ä«na</option>
                <option value="hours">Stundas</option>
            </select>
        </label>
        <div id="totalHoursDisplay" style="margin: 10px; font-size: 1.2em; font-weight: bold; color: #0f1a14;">
            KopÄ nostrÄdÄtÄs stundas: <span id="totalHoursValue">0.00</span> h
        </div>
    </div>
    <div id="tableContainer"></div>
</div>

<script>
    // MÄ“neÅ¡u secÄ«bas definÄ«cija pareizai kÄrtoÅ¡anai
    const MONTH_ORDER = ["JanvÄris","FebruÄris","Marts","AprÄ«lis","Maijs","JÅ«nijs","JÅ«lijs","Augusts","Septembris","Oktobris","Novembris","Decembris"];
    
    // HTML elementu saglabÄÅ¡ana mainÄ«gajos
    const workerList = document.getElementById("workerList");
    const carList = document.getElementById("carList");
    const tableContainer = document.getElementById("tableContainer");
    const filterMonth = document.getElementById("filterMonth");
    const filterWorker = document.getElementById("filterWorker");
    const filterDate = document.getElementById("filterDate");
    const filterCar = document.getElementById("filterCar");
    const sortBy1 = document.getElementById("sortBy");
    const sortBy2 = document.getElementById("sortBy2");
    
    // MainÄ«gie, kuros glabÄsies no servera saÅ†emtie dati
    let workers = [];
    let cars = [];
    let schedule = [];

    // GalvenÄ funkcija, kas pieprasa datus no servera (API)
    async function loadData() {
        try {
            const [wRes, cRes, sRes] = await Promise.all([fetch('/api/workers'), fetch('/api/cars'), fetch('/api/schedule')]);
            if (!wRes.ok || !cRes.ok || !sRes.ok) throw new Error("NeizdevÄs iegÅ«t datus");
            workers = await wRes.json();
            cars = await cRes.json();
            schedule = await sRes.json();
            
            // PÄ“c datu saÅ†emÅ¡anas, tos attÄ“lo ekrÄnÄ
            renderWorkers();
            renderCars();
            fillFilter(filterMonth, schedule.map(e => e.month));
            fillFilter(filterDate, schedule.map(e => e.date).sort((a,b) => a-b));
            renderTable();
        } catch (err) { console.error("KÄ¼Å«da:", err); }
    }

    // Funkcija, kas izveido darbinieku sarakstu alfabÄ“tiskÄ secÄ«bÄ
    function renderWorkers() {
        const sortedWorkers = [...workers].sort((a, b) => a.name.localeCompare(b.name, 'lv'));
        workerList.innerHTML = sortedWorkers.map(w => {
            const tempPassHtml = (w.temp_password && w.temp_password !== "NULL") ? `<span class="pw">(Temp: ${w.temp_password})</span>` : "";
            return `<li><span><strong>${w.name}</strong>${tempPassHtml}</span><button onclick="deleteWorker('${w.name}')">DzÄ“st</button></li>`;
        }).join("");
        fillFilter(filterWorker, sortedWorkers.map(w => w.name));
    }

    // Funkcija, kas izveido maÅ¡Ä«nu sarakstu alfabÄ“tiskÄ secÄ«bÄ
    function renderCars() {
        const sortedCars = [...cars].sort((a, b) => a.localeCompare(b, 'lv'));
        carList.innerHTML = sortedCars.map(c => `<li><strong>${c}</strong><button onclick="deleteCar('${c}')">DzÄ“st</button></li>`).join("");
        fillFilter(filterCar, sortedCars);
    }

    // PalÄ«gfunkcija, kas aizpilda filtru izvÄ“lnes (select) ar unikÄlÄm vÄ“rtÄ«bÄm
    function fillFilter(select, list) {
        const current = select.value;
        const uniqueValues = [...new Set(list)];
        select.innerHTML = `<option value="">Visi</option>` + uniqueValues.map(v => `<option value="${v}">${v}</option>`).join("");
        select.value = current;
    }

    // Funkcija, kas filtrÄ“, kÄrto un uzzÄ«mÄ“ galveno datu tabulu
    function renderTable() {
        // Datu filtrÄ“Å¡ana pÄ“c lietotÄja izvÄ“les
        let filtered = schedule.filter(e => {
            return (!filterMonth.value || e.month === filterMonth.value) &&
            (!filterWorker.value || e.worker_name === filterWorker.value) &&
            (!filterDate.value || String(e.date) === filterDate.value) &&
            (!filterCar.value || e.car === filterCar.value);
        });

        // Stundu summÄ“Å¡ana visiem nofiltrÄ“tajiem ierakstiem
        const total = filtered.reduce((sum, item) => sum + (parseFloat(item.hours) || 0), 0);
        document.getElementById("totalHoursValue").textContent = total.toFixed(2);

        // Tabulas kÄrtoÅ¡anas loÄ£ika
        if (!sortBy1.value && !sortBy2.value) {
            filtered.sort((a, b) => b.id - a.id); 
        } else {
            const sortLogic = (a, b, key) => {
                if (!key) return 0;
                if (key === 'month') return MONTH_ORDER.indexOf(a.month) - MONTH_ORDER.indexOf(b.month);
                if (key === 'date') return parseInt(a.date) - parseInt(b.date);
                if (key === 'hours') return parseFloat(a.hours) - parseFloat(b.hours);
                return String(a[key] || "").localeCompare(String(b[key] || ""));
            };
            filtered.sort((a, b) => sortLogic(a, b, sortBy1.value) || sortLogic(a, b, sortBy2.value));
        }

        // Tabulas HTML Ä£enerÄ“Å¡ana
        if (!filtered.length) { tableContainer.innerHTML = "<p style='padding:20px;'>Nav ierakstu.</p>"; return; }
        let html = `<table><tr><th>MÄ“nesis</th><th>Darbinieks</th><th>Datums</th><th>MaÅ¡Ä«na</th><th>KopÅ¡</th><th>LÄ«dz</th><th>Stundas</th></tr>`;
        filtered.forEach(e => {
            html += `<tr><td>${e.month || '-'}</td><td>${e.worker_name}</td><td>${e.date}</td><td>${e.car}</td><td>${e.sÄkuma_laiks || '-'}</td><td>${e.beigu_laiks || 'AktÄ«vs'}</td><td>${e.hours || '-'}</td></tr>`;
        });
        tableContainer.innerHTML = html + `</table>`;
    }

    // KlausÄ«tÄji, kas reaÄ£Ä“ uz izmaiÅ†Äm filtros vai kÄrtoÅ¡anÄ
    [filterMonth, filterWorker, filterDate, filterCar, sortBy1, sortBy2].forEach(el => el.addEventListener("change", renderTable));
    
    // Filtru notÄ«rÄ«Å¡anas poga
    document.getElementById("clearFilters").onclick = () => {
        [filterMonth, filterWorker, filterDate, filterCar, sortBy1, sortBy2].forEach(el => el.value = "");
        renderTable();
    };

    // Jauna darbinieka pievienoÅ¡ana (izsauc prompt logus)
    document.getElementById("addWorkerBtn").onclick = async () => {
        const name = prompt("Ievadiet darbinieka vÄrdu:");
        if(!name || !name.trim()) return;
        const temp_pass = prompt(`Ievadiet pagaidu paroli priekÅ¡ ${name}:`);
        if(!temp_pass || !temp_pass.trim()) return;
        const res = await fetch('/api/workers', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: name.trim(), temp_password: temp_pass.trim() }) });
        if(res.ok) { alert("Pievienots!"); loadData(); }
    };

    // Jaunas maÅ¡Ä«nas pievienoÅ¡ana
    document.getElementById("addCarBtn").onclick = async () => {
        const name = prompt("Ievadiet jaunu maÅ¡Ä«nu:");
        if(!name || !name.trim()) return;
        const res = await fetch('/api/cars', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: name.trim() }) });
        if(res.ok) { alert("Pievienota!"); loadData(); }
    };

    // Darbinieka dzÄ“Å¡ana
    async function deleteWorker(name) {
        if(!confirm(`DzÄ“st darbinieku ${name}?`)) return;
        const res = await fetch(`/api/workers/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if(res.ok) loadData();
    }

    // MaÅ¡Ä«nas dzÄ“Å¡ana
    async function deleteCar(name) {
        if (!confirm(`Vai tieÅ¡Äm vÄ“laties dzÄ“st maÅ¡Ä«nu ${name}?`)) return;
        try {
            const res = await fetch(`/api/cars/${encodeURIComponent(name)}`, { method: 'DELETE' });
            if (res.ok) loadData();
        } catch (err) { console.error(err); }
    }

    // Visas grafika tabulas pilnÄ«ga notÄ«rÄ«Å¡ana
    document.getElementById("clearTableBtn").onclick = async () => {
        if (confirm("Vai tieÅ¡Äm vÄ“laties izdzÄ“st VISUS ierakstus?")) {
            try {
                const res = await fetch('/api/schedule', { method: 'DELETE' });
                if (res.ok) { alert("NotÄ«rÄ«ts!"); loadData(); }
            } catch (err) { console.error(err); }
        }
    };

    // SÄkotnÄ“jÄ datu ielÄde, kad lapa tiek atvÄ“rta
    loadData();
</script>
</body>
</html>
