<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panelis</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f4f6f1; padding: 10px; font-size: 12px; }
        h2, h3 { margin: 5px 0; font-size: 1.1em; color: #2c3e50; }
        .top-section { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .config-box { background: white; border: 1px solid #ccc; padding: 8px; border-radius: 5px; min-width: 150px; flex: 1; }
        .config-box ul { list-style: none; padding: 0; margin: 5px 0; max-height: 100px; overflow-y: auto; border-top: 1px solid #eee; }
        .config-box li { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid #fafafa; }
        .main-tables-wrapper { display: flex; flex-direction: row; align-items: flex-start; gap: 10px; width: 100%; overflow-x: auto; }
        .table-column { background: white; border: 1px solid #ccc; border-radius: 5px; padding: 5px; flex: 1; min-width: 300px; }
        table { border-collapse: collapse; width: 100%; line-height: 1.1; }
        th { background: #f8f9fa; padding: 4px; border: 1px solid #dee2e6; text-align: left; font-size: 11px; }
        td { padding: 2px 4px; border: 1px solid #eee; white-space: nowrap; }
        tr:hover { background: #f1f1f1; }
        .btn-del { cursor: pointer; border: none; background: none; color: red; font-weight: bold; padding: 0 5px; }
        .total-bar { background: #e9ecef; padding: 8px; border-radius: 5px; margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

<h2>Admin Panelis</h2>

<div class="top-section">
    <div class="config-box">
        <h3>ğŸ‘· Darbinieki <button id="addWorkerBtn">+</button></h3>
        <ul id="workerList"></ul>
    </div>
    <div class="config-box">
        <h3>ğŸš— MaÅ¡Ä«nas <button id="addCarBtn">+</button></h3>
        <ul id="carList"></ul>
    </div>
    <div class="config-box">
        <h3>ğŸ“ Objekti/Darbi <button id="addObjectBtn">+</button></h3>
        <ul id="objectList"></ul>
    </div>
    <div class="config-box" style="background: #fdf6e3;">
        <h3>ğŸ” Filtri</h3>
        MÄ“nesis: <select id="filterMonth"><option value="">Visi</option></select><br>
        Darbinieks: <select id="filterWorker"><option value="">Visi</option></select><br>
        <button id="clearFilters" style="margin-top:5px;">NotÄ«rÄ«t</button>
    </div>
</div>

<div class="total-bar">KopÄ nostrÄdÄts: <span id="totalHoursValue">0.00</span> h</div>

<div class="main-tables-wrapper">
    <div class="table-column">
        <h3>ğŸ› ï¸ Darba uzdevumi</h3>
        <div id="tableContainer"></div>
    </div>
    <div class="table-column">
        <h3>ğŸ“… Iebrauca / Izbrauca</h3>
        <div id="daySummaryContainer"></div>
    </div>
    <div class="table-column">
        <h3>â›½ Resursi (EÄ¼Ä¼a/Degviela)</h3>
        <div id="oilContainer"></div>
    </div>
</div>

<script>
    let workers = [], cars = [], schedule = [], objects = [], daySummary = [];

    async function loadData() {
        try {
            const [wRes, cRes, sRes, oRes, dsRes] = await Promise.all([
                fetch('/api/workers'), fetch('/api/cars'), fetch('/api/schedule'),
                fetch('/api/objects'), fetch('/api/darba-stundas')
            ]);
            workers = await wRes.json();
            cars = await cRes.json();
            schedule = await sRes.json();
            objects = await oRes.json();
            daySummary = await dsRes.json();
            
            renderSettings();
            fillFilters();
            renderTables();
        } catch (err) { console.error("Datu kÄ¼Å«da:", err); }
    }

    function renderSettings() {
        const fill = (id, data, delFn) => {
            document.getElementById(id).innerHTML = data.map(item => {
                const name = item.name || item.worker_name || item.car || ""; 
                return `<li>${name} <button class="btn-del" onclick="${delFn}('${name}')">Ã—</button></li>`;
            }).join("");
        };
        fill("workerList", workers, "deleteWorker");
        fill("carList", cars, "deleteCar");
        fill("objectList", objects, "deleteObject");
    }

    function fillFilters() {
        const mSel = document.getElementById("filterMonth");
        const wSel = document.getElementById("filterWorker");
        const months = [...new Set(schedule.map(e => e.month))];
        mSel.innerHTML = '<option value="">Visi</option>' + months.map(m => `<option value="${m}">${m}</option>`).join("");
        wSel.innerHTML = '<option value="">Visi</option>' + workers.map(w => `<option value="${w.name || w.worker_name}">${w.name || w.worker_name}</option>`).join("");
    }

    function renderTables() {
        const fMonth = document.getElementById("filterMonth").value;
        const fWorker = document.getElementById("filterWorker").value;

        // FiltrÄ“Å¡ana izmantojot pareizos datubÄzes laukus
        const filtSchedule = schedule.filter(e => (!fMonth || e.month === fMonth) && (!fWorker || e.worker_name === fWorker));
        const filtDays = daySummary.filter(e => (!fMonth || e.month === fMonth) && (!fWorker || e.darbinieks === fWorker));

        // 1. DARBU TABULA (Izmantojam from_time un to_time no tavas bildes)
        let h1 = `<table><tr><th>Datums</th><th>Auto</th><th>VÄrds</th><th>Darbs</th><th>KopÅ¡</th><th>LÄ«dz</th><th>h</th></tr>`;
        h1 += filtSchedule.map(e => `<tr>
            <td>${e.date || ""}</td>
            <td>${e.car || ""}</td>
            <td>${e.worker_name || ""}</td>
            <td>${e.darbs || ""}</td>
            <td>${e.from_time || ""}</td>
            <td>${e.to_time || ""}</td>
            <td><b>${parseFloat(e.hours || 0).toFixed(2)}</b></td>
        </tr>`).join("");
        document.getElementById("tableContainer").innerHTML = h1 + "</table>";

        // 2. DIENU TABULA (Izmantojam sÄka_darbu un beidza_darbu no tavas bildes)
        let h2 = `<table><tr><th>Datums</th><th>VÄrds</th><th>SÄka</th><th>Beidza</th><th>KopÄ</th></tr>`;
        h2 += filtDays.slice().reverse().map(e => `<tr>
            <td>${e.datums || ""}</td>
            <td>${e.darbinieks || ""}</td>
            <td style="color:green">${e.sÄka_darbu || ""}</td>
            <td style="color:red">${e.beidza_darbu || ""}</td>
            <td>${e.stundas || 0} h</td>
        </tr>`).join("");
        document.getElementById("daySummaryContainer").innerHTML = h2 + "</table>";

        // 3. RESURSU TABULA (Izmantojam pielietÄ_eÄ¼Ä¼a un pielietÄ_degviela)
        let h3 = `<table><tr><th>Datums</th><th>Auto</th><th>EÄ¼Ä¼a</th><th>Degv.</th></tr>`;
        const resursi = filtSchedule.filter(e => (parseFloat(e.pielietÄ_eÄ¼Ä¼a) > 0 || parseFloat(e.pielietÄ_degviela) > 0));
        h3 += resursi.map(e => `<tr>
            <td>${e.date || ""}</td>
            <td>${e.car || ""}</td>
            <td style="color:purple">${e.pielietÄ_eÄ¼Ä¼a || 0}L</td>
            <td style="color:orange">${e.pielietÄ_degviela || 0}L</td>
        </tr>`).join("");
        document.getElementById("oilContainer").innerHTML = h3 + "</table>";

        const total = filtSchedule.reduce((sum, i) => sum + (parseFloat(i.hours) || 0), 0);
        document.getElementById("totalHoursValue").textContent = total.toFixed(2);
    }

    document.getElementById("filterMonth").onchange = renderTables;
    document.getElementById("filterWorker").onchange = renderTables;
    document.getElementById("clearFilters").onclick = () => { 
        document.getElementById("filterMonth").value = ""; 
        document.getElementById("filterWorker").value = ""; 
        renderTables(); 
    };

    loadData();
</script>
</body>
</html>
