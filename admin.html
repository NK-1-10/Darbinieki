<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        h2, h3 { margin-top: 20px; }
        button { padding: 8px 12px; margin: 4px 0; border-radius: 6px; border: 1px solid #aaa; background: #e0e0e0; cursor: pointer; }
        button:hover { background: #d5d5d5; }
        ul { list-style: none; padding: 0; margin: 6px 0; max-width: 400px; }
        li { background:#fff; margin:6px 0; padding:8px 10px; border-radius:6px; border:1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .pw { color:#666; font-style:italic; margin-left:8px; font-size: 0.9em; }
        details { margin-bottom: 15px; background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 10px; max-width: 450px; }
        summary { cursor: pointer; font-weight: bold; padding: 4px; }
        table { border-collapse: collapse; margin-top: 20px; width: 100%; background: #fff; }
        th, td { border: 1px solid #333; padding: 6px 12px; text-align: center; }
        #filters { background: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 6px; max-width: 700px; margin-bottom: 15px; }
        select { padding: 4px 6px; border-radius: 4px; }
    </style>
</head>
<body>

<h2>Pievienot darbiniekus un maÅ¡Ä«nas</h2>

<details open>
    <summary>ðŸ‘· Pievienot darbiniekus</summary>
    <button id="addWorkerBtn">âž• Pievienot darbinieku</button>
    <ul id="workerList"></ul>
</details>

<details>
    <summary>ðŸš— Pievienot maÅ¡Ä«nas</summary>
    <button id="addCarBtn">âž• Pievienot maÅ¡Ä«nu</button>
    <ul id="carList"></ul>
</details>

<div style="text-align: right; margin-bottom: 10px;">
    <button id="clearTableBtn" style="background:#ff6666; color:white; border:none;">Clear Table</button>
</div>

<h3>Tabula</h3>

<div id="filters">
    <label>MÄ“nesis: <select id="filterMonth"><option value="">All</option></select></label>
    <label>Darbinieks: <select id="filterWorker"><option value="">All</option></select></label>
    <label>Datums: <select id="filterDate"><option value="">All</option></select></label>
    <label>MaÅ¡Ä«na: <select id="filterCar"><option value="">All</option></select></label>

    <br><br>

    <label>Sort By (top):
        <select id="sortBy">
            <option value="">None</option>
            <option value="month">Month</option>
            <option value="worker">Worker</option>
            <option value="date">Date</option>
            <option value="car">Car</option>
            <option value="hours">Hours</option>
        </select>
    </label>

    <button id="clearFilters">Clear Filters</button>
</div>

<div id="tableContainer"></div>

<div style="margin-top: 20px; padding: 10px; background: #fff; border-radius: 6px; border: 1px solid #ccc; max-width: fit-content;">
    <label>Sort By (bottom):
        <select id="sortBy2">
            <option value="">None</option>
            <option value="month">Month</option>
            <option value="worker">Worker</option>
            <option value="date">Date</option>
            <option value="car">Car</option>
            <option value="hours">Hours</option>
        </select>
    </label>
</div>

<script>
    const MONTH_ORDER = ["JanvÄris","FebruÄris","Marts","AprÄ«lis","Maijs","JÅ«nijs",
                         "JÅ«lijs","Augusts","Septembris","Oktobris","Novembris","Decembris"];

    const workerList = document.getElementById("workerList");
    const carList = document.getElementById("carList");
    const tableContainer = document.getElementById("tableContainer");
    const filterMonth = document.getElementById("filterMonth");
    const filterWorker = document.getElementById("filterWorker");
    const filterDate = document.getElementById("filterDate");
    const filterCar = document.getElementById("filterCar");
    const sortBy1 = document.getElementById("sortBy");
    const sortBy2 = document.getElementById("sortBy2");

    let workers = [];
    let cars = [];
    let schedule = [];

    async function loadData() {
        try {
            const [wRes, cRes, sRes] = await Promise.all([
                fetch('/api/workers'),
                fetch('/api/cars'),
                fetch('/api/schedule')
            ]);
            workers = await wRes.json();
            cars = await cRes.json();
            schedule = await sRes.json();

            renderWorkers();
            renderCars();
            fillFilter(filterMonth, schedule.map(e => e.month));
            fillFilter(filterDate, schedule.map(e => e.date).sort((a,b) => a-b));
            renderTable();
        } catch (err) {
            console.error("KÄ¼Å«da ielÄdÄ“jot datus:", err);
        }
    }

    function handleSortChange(e) {
        const val = e.target.value;
        sortBy1.value = val;
        sortBy2.value = val;
        renderTable();
    }

    document.getElementById("addWorkerBtn").onclick = async () => {
        const name = prompt("Ievadiet darbinieka vÄrdu:");
        if(!name || !name.trim()) return;
        const temp_pass = prompt(`Ievadiet pagaidu paroli priekÅ¡ ${name}:`);
        if(!temp_pass || !temp_pass.trim()) return;

        const res = await fetch('/api/workers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: name.trim(), temp_password: temp_pass.trim() })
        });
        if(res.ok) { alert("Pievienots!"); loadData(); }
    };

    document.getElementById("addCarBtn").onclick = async () => {
        const name = prompt("Ievadiet jaunu maÅ¡Ä«nu:");
        if(!name || !name.trim()) return;
        const res = await fetch('/api/cars', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: name.trim() })
        });
        if(res.ok) { alert("Pievienota!"); loadData(); }
    };

    async function deleteWorker(name) {
        if(!confirm(`DzÄ“st darbinieku ${name}?`)) return;
        const res = await fetch(`/api/workers/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if(res.ok) { loadData(); }
    }

    function renderWorkers() {
        workerList.innerHTML = workers.map(w => {
            const tempPassHtml = (w.temp_password && w.temp_password !== "NULL") 
                ? `<span class="pw">(Temp: ${w.temp_password})</span>` : "";
            return `<li><span><strong>${w.name}</strong>${tempPassHtml}</span>
                    <button onclick="deleteWorker('${w.name}')" style="margin-left:10px;">DzÄ“st</button></li>`;
        }).join("");
        fillFilter(filterWorker, workers.map(w => w.name));
    }

    function renderCars() {
        carList.innerHTML = cars.map(c => `<li><strong>${c}</strong></li>`).join("");
        fillFilter(filterCar, cars);
    }

    function fillFilter(select, list) {
        const current = select.value;
        const uniqueValues = [...new Set(list)];
        select.innerHTML = `<option value="">Visi</option>` + 
            uniqueValues.map(v => `<option value="${v}">${v}</option>`).join("");
        select.value = current;
    }

    function renderTable() {
        let filtered = schedule.filter(e => {
            return (!filterMonth.value || e.month === filterMonth.value) &&
                   (!filterWorker.value || e.worker_name === filterWorker.value) &&
                   (!filterDate.value || String(e.date) === filterDate.value) &&
                   (!filterCar.value || e.car === filterCar.value);
        });

        const key = sortBy1.value;
        if (key) {
            filtered.sort((a, b) => {
                if (key === 'month') return MONTH_ORDER.indexOf(a.month) - MONTH_ORDER.indexOf(b.month);
                if (key === 'date') return parseInt(a.date) - parseInt(b.date);
                if (key === 'worker') return a.worker_name.localeCompare(b.worker_name);
                return String(a[key] || "").localeCompare(String(b[key] || ""));
            });
        }

        if (!filtered.length) {
            tableContainer.innerHTML = "<p>Nav ierakstu.</p>";
            return;
        }

        let html = `<table><tr><th>MÄ“nesis</th><th>Darbinieks</th><th>Datums</th><th>MaÅ¡Ä«na</th><th>KopÅ¡</th><th>LÄ«dz</th><th>Stundas</th></tr>`;
        filtered.forEach(e => {
            html += `<tr><td>${e.month}</td><td>${e.worker_name}</td><td>${e.date}</td><td>${e.car}</td><td>${e.from_time}</td><td>${e.to_time}</td><td>${e.hours}</td></tr>`;
        });
        tableContainer.innerHTML = html + `</table>`;
    }

    [filterMonth, filterWorker, filterDate, filterCar].forEach(el => el.addEventListener("change", renderTable));
    sortBy1.addEventListener("change", handleSortChange);
    sortBy2.addEventListener("change", handleSortChange);

    document.getElementById("clearFilters").onclick = () => {
        [filterMonth, filterWorker, filterDate, filterCar, sortBy1, sortBy2].forEach(el => el.value = "");
        renderTable();
    };

    loadData();
</script>
</body>
</html>
