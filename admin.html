<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panelis</title>
    <style>
        /* CSS sadaÄ¼a - nosaka kÄ izskatÄs pogas, tabula un izkÄrtojums */
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: #f4f6f1; color: #0f1a14; padding: 20px; display: flex; flex-direction: column; align-items: flex-start; }
        h2, h3 { margin-top: 30px; text-align: left; color: #2c3e50; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 900px; margin-bottom: 30px; }
        details.pogas { background: #ffffff; border: 1px solid #ccc; border-radius: 8px; width: 100% !important; overflow: hidden; transition: box-shadow 0.3s; }
        details.pogas:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        summary { cursor: pointer; font-weight: bold; padding: 15px; background: #f8f9fa; list-style: none; }
        details[open] summary { border-bottom: 1px solid #eee; background: #eef2eb; }
        .content { padding: 15px; }
        button { padding: 8px 15px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        button:hover { background: #f0f0f0; }
        ul { list-style: none; padding: 0; margin-top: 10px; }
        li { background: #fdfdfd; margin-bottom: 5px; padding: 8px 12px; border-radius: 5px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        li button { padding: 4px 8px; font-size: 12px; background: #fee; border-color: #fcc; color: #c33; }
        #filters { background: #fff; border: 1px solid #ccc; padding: 20px; border-radius: 10px; width: 100%; max-width: 890px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        #filters label { display: flex; flex-direction: column; font-size: 13px; font-weight: bold; color: #555; }
        select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; background: #fff; margin-top: 5px; min-width: 140px; }
        #table-wrapper { background: #fff; border: 1px solid #ccc; border-radius: 10px; overflow: hidden; width: 100%; max-width: 1400px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .table-controls { background: #f8f9fa; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        #totalHoursDisplay { background: #eef2eb; padding: 10px 15px; border-radius: 8px; border: 1px solid #c3d9c3; font-weight: bold; color: #2c5d2c; }
        table { border-collapse: collapse; width: 100%; font-size: 14px; }
        th { background: #f1f3f5; padding: 12px; border-bottom: 2px solid #dee2e6; color: #495057; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
    </style>
</head>
<body>

<h2>IestatÄ«jumi</h2>

<div class="grid-container">
    <details class="pogas">
        <summary>ğŸ‘· Darbinieki</summary>
        <div class="content">
            <button id="addWorkerBtn">â• Pievienot darbinieku</button>
            <ul id="workerList"></ul> </div>
    </details>

    <details class="pogas">
        <summary>ğŸš— MaÅ¡Ä«nas</summary>
        <div class="content">
            <button id="addCarBtn">â• Pievienot maÅ¡Ä«nu</button>
            <ul id="carList"></ul> </div>
    </details>
    
    <details class="pogas">
        <summary>âš’ï¸ Darba veidi</summary>
        <div class="content">
            <button id="addWorkBtn">â• Pievienot veidu</button>
            <ul id="workList"></ul> </div>
    </details>

    <details class="pogas">
        <summary>ğŸ“ Objekti</summary>
        <div class="content">
            <button id="addObjectBtn">â• Pievienot objektu</button>
            <ul id="objectList"></ul> </div>
    </details>
</div>

<h3>MeklÄ“Å¡anas filtri</h3>

<div id="filters" style="display: flex; gap: 30px; margin-bottom: 20px;">
    <label>MÄ“nesis: <select id="filterMonth"><option value="">Visi</option></select></label>
    <label>Darbinieks: <select id="filterWorker"><option value="">Visi</option></select></label>
    <label>Datums (diena): <select id="filterDate"><option value="">Visi</option></select></label>
    <label>MaÅ¡Ä«na: <select id="filterCar"><option value="">Visi</option></select></label>
    <button id="clearFilters" style="background: #eee;">NotÄ«rÄ«t filtrus</button>
</div>

<div class="action-bar" style="display: flex; gap: 30px; margin-bottom: 20px;">
    <button id="clearTableBtn" style="background:#ff6666; color:white; border:none; padding: 10px 20px;">IztÄ«rÄ«t visu tabulu</button>
</div>

<div id="table-wrapper" style="display: flex; gap: 30px; margin-bottom: 20px;">
    <div class="table-controls">
        <div style="display: flex; gap: 10px;">
            <label>KÄrtot: <select id="sortBy">
                <option value="">Nekas</option>
    <option value="month">MÄ“nesis</option>
    <option value="worker_name">Darbinieks</option>
    <option value="date">Datums</option>
    <option value="car">MaÅ¡Ä«na</option>
    <option value="hours">Stundas</option>
            </select></label>
        </div>
        <div id="totalHoursDisplay">
            KopÄ: <span id="totalHoursValue">0.00</span> h
        </div>
    </div>
    <div id="tableContainer"></div> </div>

<script>
    // 1. NodefinÄ“jam mÄ“neÅ¡u kÄrtÄ«bu, lai kÄrtojot tie bÅ«tu pareizÄ secÄ«bÄ (nevis pÄ“c alfabÄ“ta)
    const MONTH_ORDER = ["JanvÄris","FebruÄris","Marts","AprÄ«lis","Maijs","JÅ«nijs","JÅ«lijs","Augusts","Septembris","Oktobris","Novembris","Decembris"];
    
    // 2. MainÄ«gie, kas glabÄs datus no servera
    let workers = [], cars = [], schedule = [], works_types = [], objects = [];

    // --- FUNKCIJA: IelÄdÄ“ datus no servera (API) ---
    async function loadData() {
        try {
            // VienlaicÄ«gi palÅ«dzam visus datus
            const [wRes, cRes, sRes, wtRes, oRes] = await Promise.all([
                fetch('/api/workers'), fetch('/api/cars'), fetch('/api/schedule'),
                fetch('/api/work-types'), fetch('/api/objects')
            ]);
            
            // PÄrvÄ“rÅ¡am datus no JSON formÄta
            workers = await wRes.json();
            cars = await cRes.json();
            schedule = await sRes.json();
            works_types = await wtRes.json();
            objects = await oRes.json();
            
            // PalaiÅ¾am sarakstu un tabulas zÄ«mÄ“Å¡anu
            renderWorkers();
            renderCars();
            renderWork();
            renderObject();
            
            // AizpildÄm filtru izvÄ“lnes ar unikÄlÄm vÄ“rtÄ«bÄm
            fillFilter(document.getElementById("filterMonth"), schedule.map(e => e.month));
            fillFilter(document.getElementById("filterWorker"), workers.map(w => w.name));
            fillFilter(document.getElementById("filterCar"), cars);

            // SpeciÄla loÄ£ika datuma filtram (dabÅ«jam dienas skaitli)
            const days = schedule.map(e => e.date ? e.date.split('.')[0] : null).filter(Boolean);
            fillFilter(document.getElementById("filterDate"), [...new Set(days)].sort((a, b) => a - b));

            renderTable(); // UzÄ£enerÄ“jam galveno tabulu
        } catch (err) { console.error("KÄ¼Å«da ielÄdÄ“jot datus:", err); }
    }

    // --- FUNKCIJAS: Sarakstu renderÄ“Å¡ana (Darbinieki, Auto utt.) ---
    function renderWorkers() {
        workers.sort((a,b) => a.name.localeCompare(b.name, 'lv')); // SakÄrtojam pÄ“c vÄrda
        // Izveidojam sarakstu ar "DzÄ“st" pogu katram
        document.getElementById("workerList").innerHTML = workers.map(w => `
            <li>
                <span><strong>${w.name}</strong> ${w.temp_password ? `<small>(${w.temp_password})</small>` : ''}</span>
                <button onclick="deleteWorker('${w.name}')">DzÄ“st</button>
            </li>`).join("");
    }

    function renderCars() {
        cars.sort((a,b) => a.localeCompare(b, 'lv'));
        document.getElementById("carList").innerHTML = cars.map(c => `<li><strong>${c}</strong><button onclick="deleteCar('${c}')">DzÄ“st</button></li>`).join("");
    }

    function renderWork() {
        works_types.sort((a,b) => a.localeCompare(b, 'lv'));
        document.getElementById("workList").innerHTML = works_types.map(w => `<li><strong>${w}</strong><button onclick="deleteWorkType('${w}')">DzÄ“st</button></li>`).join("");
    }

    function renderObject() {
        objects.sort((a,b) => a.localeCompare(b, 'lv'));
        document.getElementById("objectList").innerHTML = objects.map(o => `<li><strong>${o}</strong><button onclick="deleteObject('${o}')">DzÄ“st</button></li>`).join("");
    }

    // --- PALÄªGFUNKCIJA: Ievieto unikÄlas vÄ“rtÄ«bas filtru selectos ---
    function fillFilter(select, list) {
        const current = select.value;
        const uniqueValues = [...new Set(list)].filter(Boolean); // NoÅ†emam dublikÄtus un tukÅ¡umus
        select.innerHTML = `<option value="">Visi</option>` + uniqueValues.map(v => `<option value="${v}">${v}</option>`).join("");
        select.value = current; // SaglabÄjam izvÄ“li, ja tÄda bija
    }

    // --- GALVENÄ€ FUNKCIJA: Tabulas Ä£enerÄ“Å¡ana un filtrÄ“Å¡ana ---
    function renderTable() {
        // 1. FiltrÄ“jam ierakstus balstoties uz izvÄ“lÄ“tajiem filtriem
        let filtered = schedule.filter(e => {
            const dayOnly = e.date ? e.date.split('.')[0] : ""; 
            return (!document.getElementById("filterMonth").value || e.month === document.getElementById("filterMonth").value) &&
                   (!document.getElementById("filterWorker").value || e.worker_name === document.getElementById("filterWorker").value) &&
                   (!document.getElementById("filterDate").value || dayOnly === document.getElementById("filterDate").value) && 
                   (!document.getElementById("filterCar").value || e.car === document.getElementById("filterCar").value);
        });

        // 2. SaskaitÄm kopÄ“jÄs stundas filtrÄ“tajiem datiem
        const total = filtered.reduce((sum, item) => sum + (parseFloat(item.hours) || 0), 0);
        document.getElementById("totalHoursValue").textContent = total.toFixed(2);

        // 3. KÄrtoÅ¡anas loÄ£ika
        const sortKey = document.getElementById("sortBy").value;
        filtered.sort((a, b) => {
    if (!sortKey) return b.id - a.id;
    if (sortKey === 'month') return MONTH_ORDER.indexOf(a.month) - MONTH_ORDER.indexOf(b.month);
    
    // PAPILDINÄ€TS: SkaitliskÄ kÄrtoÅ¡ana eÄ¼Ä¼ai, degvielai un stundÄm
    if (['hours', 'pielietÄ_eÄ¼Ä¼a', 'pielietÄ_degviela'].includes(sortKey)) {
        return (parseFloat(a[sortKey]) || 0) - (parseFloat(b[sortKey]) || 0);
    }
    
    return String(a[sortKey] || "").localeCompare(String(b[sortKey] || ""), 'lv');
});

        // 4. UzÄ£enerÄ“jam tabulas HTML
        if (!filtered.length) { 
        document.getElementById("tableContainer").innerHTML = "<p style='padding:20px;'>Nav ierakstu.</p>"; 
        return; 
    }
       let html = `<table><tr>
        <th>Datums</th>
        <th>MÄ“nesis</th>
        <th>MaÅ¡Ä«na</th>
        <th>Darbinieks</th>
        <th>Objekts</th>
        <th>Darbs</th>
        <th>KopÅ¡</th>
        <th>LÄ«dz</th>
        <th>Stundas</th>
    </tr>`;

    filtered.forEach(e => {
        html += `<tr>
            <td>${e.date}</td>
            <td>${e.month || '-'}</td>
            <td>${e.car}</td>
            <td>${e.worker_name}</td>
            <td>${e.objekts || '-'}</td>
            <td>${e.darbs || '-'}</td>
            <td>${e.sÄkuma_laiks || '-'}</td>
            <td>${e.beigu_laiks || 'AktÄ«vs'}</td>
            <td><strong>${e.hours || '-'}</strong></td>
        </tr>`;
    });
    document.getElementById("tableContainer").innerHTML = html + `</table>`;
}

    // --- NOTIKUMI (Event Listeners) - Pogas un Filtri ---

    // Pievienojam klausÄ«tÄjus visiem filtriem - ja maina vÄ“rtÄ«bu, tabula pÄrzÄ«mÄ“jas
    ["filterMonth", "filterWorker", "filterDate", "filterCar", "sortBy"].forEach(id => {
        document.getElementById(id).addEventListener("change", renderTable);
    });

    // Filtru notÄ«rÄ«Å¡ana
    document.getElementById("clearFilters").onclick = () => {
        ["filterMonth", "filterWorker", "filterDate", "filterCar", "sortBy"].forEach(id => document.getElementById(id).value = "");
        renderTable();
    };

    // DARBINIEKA PIEVIENOÅ ANA
    document.getElementById("addWorkerBtn").onclick = async () => {
        const name = prompt("Darbinieka vÄrds un uzvÄrds:");
        const pass = prompt("Pagaidu parole:");
        if(name && pass) {
            await fetch('/api/workers', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ name: name.trim(), temp_password: pass.trim() }) 
            });
            loadData(); // Atjaunojam sarakstus
        }
    };

    // MAÅ ÄªNAS PIEVIENOÅ ANA
    document.getElementById("addCarBtn").onclick = async () => {
        const name = prompt("MaÅ¡Ä«nas nosaukums vai numurs:");
        if(name) {
            await fetch('/api/cars', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: name.trim() }) });
            loadData();
        }
    };

    // DARBA VEIDA PIEVIENOÅ ANA
    document.getElementById("addWorkBtn").onclick = async () => {
        const name = prompt("Jauns darba veids (piem. RakÅ¡ana):");
        if(name) {
            await fetch('/api/work-types', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: name.trim() }) });
            loadData();
        }
    };

    // OBJEKTA PIEVIENOÅ ANA
    document.getElementById("addObjectBtn").onclick = async () => {
        const name = prompt("Objekta nosaukums vai adrese:");
        if(name) {
            await fetch('/api/objects', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: name.trim() }) });
            loadData();
        }
    };

    // --- DZÄ’Å ANAS FUNKCIJAS ---
    async function deleteWorker(name) { if(confirm(`DzÄ“st darbinieku ${name}?`)) { await fetch(`/api/workers/${encodeURIComponent(name)}`, { method: 'DELETE' }); loadData(); } }
    async function deleteCar(name) { if(confirm(`DzÄ“st maÅ¡Ä«nu ${name}?`)) { await fetch(`/api/cars/${encodeURIComponent(name)}`, { method: 'DELETE' }); loadData(); } }
    async function deleteWorkType(name) { if(confirm(`DzÄ“st darba veidu ${name}?`)) { await fetch(`/api/work-types/${encodeURIComponent(name)}`, { method: 'DELETE' }); loadData(); } }
    async function deleteObject(name) { if(confirm(`DzÄ“st objektu ${name}?`)) { await fetch(`/api/objects/${encodeURIComponent(name)}`, { method: 'DELETE' }); loadData(); } }

    // TABULAS IZTÄªRÄªÅ ANA (VÄ“stures dzÄ“Å¡ana)
    document.getElementById("clearTableBtn").onclick = async () => {
        if (confirm("VAI TIEÅ Ä€M DZÄ’ST VISU DARBA VÄ’STURI? Å o nevar atcelt.")) {
            await fetch('/api/schedule', { method: 'DELETE' });
            loadData();
        }
    };

    // SÄkam datu ielÄdi, kad lapa ir atvÄ“rta
    loadData();
</script>
</body>
</html>
