<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darba Laika Uzskaite</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        select { width: 100%; padding: 12px; margin: 20px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
        
        /* Pogas stili */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; }
        .btn-start { background: #28a745; }
        .btn-start:hover { background: #218838; }
        .btn-stop { background: #dc3545; display: none; }
        .btn-stop:hover { background: #c82333; }
        
        #status { margin-top: 15px; font-weight: bold; color: #555; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #eee; }
        #logoutBtn { margin-top: 20px; background: none; border: 1px solid #999; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="card">
        <h2 id="welcome">Sveiki!</h2>
        <div id="status">Statuss: Gaidīšana</div>

        <select id="carSelect">
            <option value="">-- Izvēlies mašīnu --</option>
        </select>

        <button id="startBtn" class="btn btn-start">SĀKT DARBU</button>
        <button id="stopBtn" class="btn btn-stop">BEIGT DARBU</button>
        
        <button id="logoutBtn">Iziet</button>
    </div>

    <h3>Tavi pēdējie ieraksti:</h3>
    <div id="tableContainer"></div>

<script>
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!user || user.role !== "worker") { window.location.href = "index.html"; }
    document.getElementById("welcome").textContent = `Sveiks, ${user.name}!`;

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const carSelect = document.getElementById("carSelect");
    const statusDiv = document.getElementById("status");

    // 1. Ielādējam mašīnas un esošos datus
   // 1. Ielādējam mašīnas un esošos datus
    async function init() {
        const [cRes, sRes] = await Promise.all([
            fetch('/api/cars'),
            fetch('/api/schedule')
        ]);
        const cars = await cRes.json();
        const schedule = await sRes.json();

        // PIEVIENO ŠO RINDIŅU ŠEIT:
        carSelect.innerHTML = '<option value="">-- Izvēlies mašīnu --</option>';

        // Aizpildām mašīnu izvēlni
        cars.forEach(c => carSelect.add(new Option(c, c)));
        
        // ... tālāk viss paliek kā bija ...

        // Pārbaudām, vai darbiniekam jau ir aktīvs darbs (start_time ir, bet end_time nav)
        const activeJob = schedule.find(e => e.worker_name === user.name && !e.end_time);
        if (activeJob) {
            showStopMode(activeJob.car, activeJob.start_time);
        }

        renderTable(schedule.filter(e => e.worker_name === user.name));
    }

    function showStopMode(car, start) {
        startBtn.style.display = "none";
        stopBtn.style.display = "block";
        carSelect.value = car;
        carSelect.disabled = true;
        statusDiv.innerHTML = `Strādā ar: <b>${car}</b><br><small>Sākts: ${start}</small>`;
    }

    // 2. START poga
    startBtn.onclick = async () => {
        if (!carSelect.value) return alert("Lūdzu, izvēlies mašīnu!");

        const res = await fetch('/api/start-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ worker_name: user.name, car: carSelect.value })
        });

        if (res.ok) {
            const data = await res.json();
            showStopMode(carSelect.value, data.startTime);
            init(); // Atsvaidzinām tabulu
        }
    };

    // 3. STOP poga
    stopBtn.onclick = async () => {
        if (!confirm("Vai tiešām beigt darbu?")) return;

        const res = await fetch('/api/stop-work', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ worker_name: user.name })
        });

        if (res.ok) {
            startBtn.style.display = "block";
            stopBtn.style.display = "none";
            carSelect.disabled = false;
            carSelect.value = "";
            statusDiv.textContent = "Statuss: Darbs pabeigts";
            init();
        }
    };

    function renderTable(data) {
        if (!data.length) { document.getElementById("tableContainer").innerHTML = "Nav vēstures."; return; }
        let html = "<table><tr><th>Mašīna</th><th>No</th><th>Līdz</th></tr>";
        // Rādām pēdējos 10 ierakstus, jaunākie augšā
        data.reverse().slice(0, 10).forEach(e => {
            html += `<tr><td>${e.car}</td><td>${e.start_time}</td><td>${e.end_time || '---'}</td></tr>`;
        });
        document.getElementById("tableContainer").innerHTML = html + "</table>";
    }

    document.getElementById("logoutBtn").onclick = () => {
        localStorage.removeItem("loggedInUser");
        window.location.href = "index.html";
    };

    init();
</script>
</body>
</html>
