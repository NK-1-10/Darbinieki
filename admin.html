<!DOCTYPE html>
<html lang="lv">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panelis</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: #f4f6f1; color: #0f1a14; padding: 20px; }
        h2, h3 { margin-top: 30px; text-align: left; color: #2c3e50; }
        
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 900px; margin-bottom: 30px; }
        details.pogas { background: #ffffff; border: 1px solid #ccc; border-radius: 8px; width: 100%; overflow: hidden; transition: box-shadow 0.3s; }
        details.pogas:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        summary { cursor: pointer; font-weight: bold; padding: 15px; background: #f8f9fa; list-style: none; }
        details[open] summary { border-bottom: 1px solid #eee; background: #eef2eb; }
        .content { padding: 15px; }
        
        button { padding: 8px 15px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        button:hover { background: #f0f0f0; }
        
        ul { list-style: none; padding: 0; margin-top: 10px; }
        li { background: #fdfdfd; margin-bottom: 5px; padding: 8px 12px; border-radius: 5px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        li button { padding: 4px 8px; font-size: 12px; background: #fee; border-color: #fcc; color: #c33; }

        #filters { background: #fff; border: 1px solid #ccc; padding: 20px; border-radius: 10px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 20px; }
        #filters label { display: flex; flex-direction: column; font-size: 13px; font-weight: bold; color: #555; }
        select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; background: #fff; margin-top: 5px; min-width: 140px; }

        /* HorizontÄlais tabulu izkÄrtojums */
        .main-layout { display: flex; gap: 20px; align-items: flex-start; width: 100%; margin-top: 20px; }
        .table-section { background: #fff; border: 1px solid #ccc; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .darbu-saraksts { flex: 2; } /* PlatÄka tabula */
        .mainu-kopsavilkums { flex: 1; } /* Å aurÄka tabula */

        .table-controls { background: #f8f9fa; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #totalHoursDisplay { background: #eef2eb; padding: 8px 12px; border-radius: 8px; border: 1px solid #c3d9c3; font-weight: bold; color: #2c5d2c; }

        table { border-collapse: collapse; width: 100%; font-size: 13px; }
        th { background: #f1f3f5; padding: 10px; border-bottom: 2px solid #dee2e6; color: #495057; text-align: center; }
        td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        tr:hover { background-color: #fcfcfc; }
    </style>
</head>
<body>

<h2>IestatÄ«jumi</h2>
<div class="grid-container">
    <details class="pogas">
        <summary>ğŸ‘· Darbinieki</summary>
        <div class="content"><button id="addWorkerBtn">â• Pievienot</button><ul id="workerList"></ul></div>
    </details>
    <details class="pogas">
        <summary>ğŸš— MaÅ¡Ä«nas</summary>
        <div class="content"><button id="addCarBtn">â• Pievienot</button><ul id="carList"></ul></div>
    </details>
    <details class="pogas">
        <summary>âš’ï¸ Darba veidi</summary>
        <div class="content"><button id="addWorkBtn">â• Pievienot</button><ul id="workList"></ul></div>
    </details>
    <details class="pogas">
        <summary>ğŸ“ Objekti</summary>
        <div class="content"><button id="addObjectBtn">â• Pievienot</button><ul id="objectList"></ul></div>
    </details>
</div>

<h3>MeklÄ“Å¡anas filtri</h3>
<div id="filters">
    <label>MÄ“nesis: <select id="filterMonth"><option value="">Visi</option></select></label>
    <label>Darbinieks: <select id="filterWorker"><option value="">Visi</option></select></label>
    <label>Datums: <select id="filterDate"><option value="">Visi</option></select></label>
    <label>MaÅ¡Ä«na: <select id="filterCar"><option value="">Visi</option></select></label>
    <button id="clearFilters" style="background: #eee;">NotÄ«rÄ«t</button>
    <button id="clearTableBtn" style="background:#ff6666; color:white; border:none;">IztÄ«rÄ«t vÄ“sturi</button>
</div>

<div class="main-layout">
    <div class="darbu-saraksts">
        <h3>Darbu saraksts</h3>
        <div class="table-section">
            <div class="table-controls">
                <label>KÄrtot: 
                    <select id="sortBy">
                        <option value="">ID (JaunÄkie)</option>
                        <option value="month">MÄ“nesis</option>
                        <option value="worker_name">Darbinieks</option>
                        <option value="date">Datums</option>
                        <option value="hours">Stundas</option>
                    </select>
                </label>
                <div id="totalHoursDisplay">KopÄ: <span id="totalHoursValue">0.00</span> h</div>
            </div>
            <div id="tableContainer"></div>
        </div>
    </div>

    <div class="mainu-kopsavilkums">
        <h3>MaiÅ†u kopsavilkums</h3>
        <div class="table-section">
            <div id="shiftTableContainer"></div>
        </div>
    </div>
</div>

<script>
    const MONTH_ORDER = ["JanvÄris","FebruÄris","Marts","AprÄ«lis","Maijs","JÅ«nijs","JÅ«lijs","Augusts","Septembris","Oktobris","Novembris","Decembris"];
    let workers = [], cars = [], schedule = [], works_types = [], objects = [], shiftRecords = [];

    async function loadData() {
        try {
            const [wRes, cRes, sRes, wtRes, oRes, shiftRes] = await Promise.all([
                fetch('/api/workers'), fetch('/api/cars'), fetch('/api/schedule'),
                fetch('/api/work-types'), fetch('/api/objects'), fetch('/api/darba-stundas-all')
            ]);
            
            workers = await wRes.json();
            cars = await cRes.json();
            schedule = await sRes.json();
            works_types = await wtRes.json();
            objects = await oRes.json();
            shiftRecords = await shiftRes.json();
            
            renderSettings();
            
            fillFilter(document.getElementById("filterMonth"), schedule.map(e => e.month));
            fillFilter(document.getElementById("filterWorker"), workers.map(w => w.name));
            fillFilter(document.getElementById("filterCar"), cars);
            const days = schedule.map(e => e.date ? e.date.split('.')[0] : null).filter(Boolean);
            fillFilter(document.getElementById("filterDate"), [...new Set(days)].sort((a, b) => a - b));

            renderAllTables();
        } catch (err) { console.error(err); }
    }

    function renderSettings() {
        document.getElementById("workerList").innerHTML = workers.map(w => `<li>${w.name} <button onclick="deleteWorker('${w.name}')">X</button></li>`).join("");
        document.getElementById("carList").innerHTML = cars.map(c => `<li>${c} <button onclick="deleteCar('${c}')">X</button></li>`).join("");
        document.getElementById("workList").innerHTML = works_types.map(w => `<li>${w} <button onclick="deleteWorkType('${w}')">X</button></li>`).join("");
        document.getElementById("objectList").innerHTML = objects.map(o => `<li>${o} <button onclick="deleteObject('${o}')">X</button></li>`).join("");
    }

    function renderAllTables() {
        renderWorkTable();
        renderShiftTable();
    }

    // --- FILTRÄ’TÄ€ DARBU TABULA ---
    function renderWorkTable() {
        let fWorker = document.getElementById("filterWorker").value;
        let fMonth = document.getElementById("filterMonth").value;
        let fDate = document.getElementById("filterDate").value;
        let fCar = document.getElementById("filterCar").value;

        let filtered = schedule.filter(e => {
            const dayOnly = e.date ? e.date.split('.')[0] : "";
            return (!fMonth || e.month === fMonth) &&
                   (!fWorker || e.worker_name === fWorker) &&
                   (!fDate || dayOnly === fDate) &&
                   (!fCar || e.car === fCar);
        });

        const total = filtered.reduce((sum, item) => sum + (parseFloat(item.hours) || 0), 0);
        document.getElementById("totalHoursValue").textContent = total.toFixed(2);

        const sortKey = document.getElementById("sortBy").value;
        filtered.sort((a, b) => {
            if (!sortKey) return b.id - a.id;
            if (sortKey === 'month') return MONTH_ORDER.indexOf(a.month) - MONTH_ORDER.indexOf(b.month);
            return String(a[sortKey] || "").localeCompare(String(b[sortKey] || ""), 'lv');
        });

        let html = `<table><tr><th>Datums</th><th>MaÅ¡Ä«na</th><th>Darbinieks</th><th>Objekts</th><th>EÄ¼Ä¼a</th><th>Degv.</th><th>Stundas</th></tr>`;
        filtered.forEach(e => {
            html += `<tr><td>${e.date}</td><td>${e.car}</td><td>${e.worker_name}</td><td>${e.objekts || '-'}</td><td>${e.pielietÄ_eÄ¼Ä¼a || '-'}</td><td>${e.pielietÄ_degviela || '-'}</td><td><b>${e.hours || '0'}</b></td></tr>`;
        });
        document.getElementById("tableContainer").innerHTML = html + `</table>`;
    }

    // --- FILTRÄ’TÄ€ MAIÅ…U TABULA ---
    function renderShiftTable() {
        let fWorker = document.getElementById("filterWorker").value;
        let fMonth = document.getElementById("filterMonth").value;

        // FiltrÄ“jam maiÅ†as pÄ“c tiem paÅ¡iem kritÄ“rijiem
        let filteredShifts = shiftRecords.filter(s => {
            return (!fMonth || s.month === fMonth) && (!fWorker || s.darbinieks === fWorker);
        });

        // KÄrtojam pÄ“c ID dilstoÅ¡Ä secÄ«bÄ (jaunÄkie augÅ¡Ä)
        filteredShifts.sort((a, b) => b.id - a.id);

        if (!filteredShifts.length) {
            document.getElementById("shiftTableContainer").innerHTML = "<p style='padding:15px;'>Nav ierakstu.</p>";
            return;
        }

        let html = `<table><tr><th>Darbinieks</th><th>Datums</th><th>SÄka</th><th>Beidza</th><th>KopÄ</th></tr>`;
        filteredShifts.forEach(s => {
            html += `<tr>
                <td>${s.darbinieks}</td>
                <td>${s.datums}</td>
                <td>${s.sÄka_darbu}</td>
                <td>${s.beidza_darbu}</td>
                <td style="background:#f0f7f0; font-weight:bold;">${s.stundas} h</td>
            </tr>`;
        });
        document.getElementById("shiftTableContainer").innerHTML = html + "</table>";
    }

    function fillFilter(select, list) {
        const current = select.value;
        const uniqueValues = [...new Set(list)].filter(Boolean);
        select.innerHTML = `<option value="">Visi</option>` + uniqueValues.map(v => `<option value="${v}">${v}</option>`).join("");
        select.value = current;
    }

    // Event Listeners
    ["filterMonth", "filterWorker", "filterDate", "filterCar", "sortBy"].forEach(id => {
        document.getElementById(id).addEventListener("change", renderAllTables);
    });

    document.getElementById("clearFilters").onclick = () => {
        ["filterMonth", "filterWorker", "filterDate", "filterCar", "sortBy"].forEach(id => document.getElementById(id).value = "");
        renderAllTables();
    };

    // CRUD OperÄcijas (PievienoÅ¡ana/DzÄ“Å¡ana)
    document.getElementById("addWorkerBtn").onclick = async () => {
        const n = prompt("VÄrds:"), p = prompt("Parole:");
        if(n && p) { await fetch('/api/workers', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: n, temp_password: p }) }); loadData(); }
    };
    document.getElementById("addCarBtn").onclick = async () => {
        const n = prompt("MaÅ¡Ä«na:");
        if(n) { await fetch('/api/cars', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: n }) }); loadData(); }
    };
    document.getElementById("addWorkBtn").onclick = async () => {
        const n = prompt("Darba veids:");
        if(n) { await fetch('/api/work-types', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: n }) }); loadData(); }
    };
    document.getElementById("addObjectBtn").onclick = async () => {
        const n = prompt("Objekts:");
        if(n) { await fetch('/api/objects', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: n }) }); loadData(); }
    };

    async function deleteWorker(n) { if(confirm("DzÄ“st?")) { await fetch(`/api/workers/${encodeURIComponent(n)}`, { method: 'DELETE' }); loadData(); } }
    async function deleteCar(n) { if(confirm("DzÄ“st?")) { await fetch(`/api/cars/${encodeURIComponent(n)}`, { method: 'DELETE' }); loadData(); } }
    async function deleteWorkType(n) { if(confirm("DzÄ“st?")) { await fetch(`/api/work-types/${encodeURIComponent(n)}`, { method: 'DELETE' }); loadData(); } }
    async function deleteObject(n) { if(confirm("DzÄ“st?")) { await fetch(`/api/objects/${encodeURIComponent(n)}`, { method: 'DELETE' }); loadData(); } }

    document.getElementById("clearTableBtn").onclick = async () => {
        if (confirm("DzÄ“st visu vÄ“sturi?")) { await fetch('/api/schedule', { method: 'DELETE' }); loadData(); }
    };

    loadData();
</script>
</body>
</html>
